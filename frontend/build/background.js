(function(){"use strict";async function Z(e){const t=new Date().toISOString(),r=e.url||"",n=e.title||"Untitled",o={target:{tabId:e.id},func:()=>window.getSelection()?.toString()?.trim()??""},[i]=await chrome.scripting.executeScript(o);return{selectedText:i?.result??"",pageUrl:r,pageTitle:n,timestamp:t}}const $="https://docs.googleapis.com/v1/documents";async function z(e,t){const r=`${$}/${e}?fields=body.content(endIndex)`,n=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const a=await n.text();let u=`Docs API error: ${n.status}`;try{const s=JSON.parse(a);s.error?.message&&(u=s.error.message)}catch{a&&(u+=` ${a.slice(0,200)}`)}throw new Error(u)}const i=(await n.json()).body?.content||[];return i.length===0?0:Math.max(...i.map(a=>a.endIndex||0))}const V=/^[\s\t]*([•·▪◦\-*]\s+)/,H=/^[\s\t]*(\d+[.)]\s+)/;function te(e,t,r,n){const o=e.split(/\n/),i=[],a=[],u=[];let s=1;for(const l of o){const d=l.match(V),h=!d&&l.match(H);let g=l,E=l.length+1;d?(g=l.replace(V,"").trimStart(),g=g||" ",E=g.length+1,a.push({start:s,end:s+g.length+1})):h?(g=l.replace(H,"").trimStart(),g=g||" ",E=g.length+1,u.push({start:s,end:s+g.length+1})):g=g||" ",i.push(g),s+=E}const m=i.join(`
`);return{textToInsert:`
`+m+t+r+n,bulletRanges:a,numberedRanges:u,quoteLen:m.length}}async function q(e,t,r){const{selectedText:n,pageUrl:o,pageTitle:i,timestamp:a}=r,u=i||"Untitled",s=n||"",m=`
Source: `,f=` ${a}`,{textToInsert:l,bulletRanges:d,numberedRanges:h,quoteLen:g}=te(s,m,u,f),E=[{insertText:{endOfSegmentLocation:{segmentId:""},text:l}}],b=`${$}/${e}:batchUpdate`;let p=await fetch(b,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:E})});if(p.status===401)throw new Error("SESSION_EXPIRED");if(!p.ok){const I=await p.text();let T=`Docs API error: ${p.status}`;try{const _=JSON.parse(I);_.error?.message&&(T=_.error.message)}catch{I&&(T+=` ${I.slice(0,200)}`)}throw new Error(T)}const D=await z(e,t),y=D-l.length,S=[];if(d.length>0){const I=d[0],T=d[d.length-1];S.push({createParagraphBullets:{range:{startIndex:y+I.start,endIndex:y+T.end},bulletPreset:"BULLET_DISC_CIRCLE_SQUARE"}})}if(h.length>0){const I=h[0],T=h[h.length-1];S.push({createParagraphBullets:{range:{startIndex:y+I.start,endIndex:y+T.end},bulletPreset:"NUMBERED_DECIMAL_ALPHA_ROMAN"}})}if(S.length>0){if(p=await fetch(b,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:S})}),p.status===401)throw new Error("SESSION_EXPIRED");if(!p.ok){const I=await p.text();let T=`Docs API error: ${p.status}`;try{const _=JSON.parse(I);_.error?.message&&(T=_.error.message)}catch{I&&(T+=` ${I.slice(0,200)}`)}throw new Error(T)}}const c=l.length,A=D-c+1+g+m.length,N=A+u.length,_e=[{updateTextStyle:{range:{startIndex:A,endIndex:N},textStyle:{link:{url:o||"#"}},fields:"link"}}];if(p=await fetch(b,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:_e})}),p.status===401)throw new Error("SESSION_EXPIRED");if(!p.ok){const I=await p.text();let T=`Docs API error: ${p.status}`;try{const _=JSON.parse(I);_.error?.message&&(T=_.error.message)}catch{I&&(T+=` ${I.slice(0,200)}`)}throw new Error(T)}}async function J(e,t,r){const{imageUrl:n,imageWidthPt:o,imageHeightPt:i,pageUrl:a,pageTitle:u,timestamp:s}=r,m=u||"Untitled",f=`
Source: `+m+" "+s,l=[{insertInlineImage:{uri:n,objectSize:{width:{magnitude:o,unit:"PT"},height:{magnitude:i,unit:"PT"}},endOfSegmentLocation:{segmentId:""}}},{insertText:{endOfSegmentLocation:{segmentId:""},text:f}}],d=`${$}/${e}:batchUpdate`;let h=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:l})});if(h.status===401)throw new Error("SESSION_EXPIRED");if(!h.ok){const y=await h.text();let S=`Docs API error: ${h.status}`;try{const c=JSON.parse(y);c.error?.message&&(S=c.error.message)}catch{y&&(S+=` ${y.slice(0,200)}`)}throw new Error(S)}const g=await z(e,t),E=f.length,b=g-E+9,p=b+m.length,D=[{updateTextStyle:{range:{startIndex:b,endIndex:p},textStyle:{link:{url:a||"#"}},fields:"link"}}];if(h=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:D})}),h.status===401)throw new Error("SESSION_EXPIRED");if(!h.ok){const y=await h.text();let S=`Docs API error: ${h.status}`;try{const c=JSON.parse(y);c.error?.message&&(S=c.error.message)}catch{y&&(S+=` ${y.slice(0,200)}`)}throw new Error(S)}}const x=typeof chrome<"u"&&chrome.identity,M="eznote_access_token";function O(){return!x||!x.getAuthToken?Promise.resolve(null):new Promise(e=>{x.getAuthToken({interactive:!1},t=>{if(chrome.runtime.lastError||!t){e(null);return}e(t)})})}function v(e){return!x||!x.removeCachedAuthToken?Promise.resolve():new Promise(t=>{x.removeCachedAuthToken({token:e},()=>{t()})})}function L(e){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.set({[M]:e})}function k(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve(null):chrome.storage.local.get(M).then(e=>e[M]||null)}const X={SELECTED_DOCUMENT_ID:"eznote_selected_document_id"};function ne(){return typeof chrome>"u"||!chrome.storage?.local?null:chrome.storage.local}function C(){const e=ne();return e?e.get(X.SELECTED_DOCUMENT_ID).then(t=>t[X.SELECTED_DOCUMENT_ID]||null):Promise.resolve(null)}const re="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKklEQVQ4T2NkYGD4z0ABYBzVMGoB1AIMDAwM/xkZGP4zMjL+Z2RkZPwPAG2cBAdMLsCFAAAAAElFTkSuQmCC";function w(e,t){typeof chrome>"u"||!chrome.notifications?.create||chrome.notifications.create({type:"basic",iconUrl:re,title:e,message:t})}async function oe(){const e=await C();if(!e)return null;const t=await O()||await k();return t?{documentId:e,accessToken:t}:null}function ie(e){const t=e instanceof Error?e.message:String(e);return t==="SESSION_EXPIRED"||t.includes("401")||t.includes("UNAUTHENTICATED")||t.includes("invalid authentication")||t.includes("Unable to download all specified images")}function j(e){const t=e instanceof Error?e.message:String(e);return t.includes("Unable to download all specified images")||t.includes("download")?"Could not add text to the document. Try again in a moment.":t.includes("SESSION_EXPIRED")||t.includes("401")?'Session expired. Open the extension and click "Connect Google Docs" to sign in again.':t||"Something went wrong. Try again."}async function Y(e){try{const t=await oe();if(!t){const o=await k(),i=await C();if(!o){w("Sign in required",'Open the EZ-Note extension and click "Connect Google Docs" to sign in.');return}if(!i){w("No document selected","Open the EZ-Note extension and select a Google Doc to connect.");return}w("Connection problem",'Open the EZ-Note extension and connect Google Docs again, then try "Plug it in" again.');return}let{documentId:r,accessToken:n}=t;try{await q(r,n,e),w("Plugged in","Highlight was added to your connected Google Doc.")}catch(o){if(ie(o)){await v(n);const i=await O();if(i){await L(i);try{await q(r,i,e),w("Plugged in","Highlight was added to your connected Google Doc.");return}catch(a){w("Could not plug in",j(a));return}}w("Session expired",'Open the extension and click "Connect Google Docs" to sign in again.');return}w("Could not plug in",j(o))}}catch(t){console.error("EZ-Note: plug it in failed",t),w("Could not plug in",j(t))}}const F="eznote-plug-it-in";function ae(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:F,title:"Plug it in",contexts:["selection"]},()=>{chrome.runtime.lastError&&console.error("EZ-Note: context menu create failed",chrome.runtime.lastError)})})}async function se(e,t){if(!(e.menuItemId!==F||!t?.id))try{const r=await Z(t);if(!r.selectedText?.trim()){w("No text selected",'Select some text on the page, then right‑click and choose "Plug it in".');return}await Y(r)}catch(r){console.error("EZ-Note: plug it in failed",r),w("Could not plug in",r instanceof Error?r.message:"Something went wrong. Try again.")}}async function ce(e){if(e)try{const t=await chrome.tabs.get(e),r=await Z(t);if(!r.selectedText?.trim()){w("No text selected",'Select some text on the page, then click "Plug it in" in the extension.');return}await Y(r)}catch(t){console.error("EZ-Note: plug it in failed",t),w("Could not plug in",t instanceof Error?t.message:"Something went wrong. Try again.")}}const le="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink,webContentLink",W="https://www.googleapis.com/drive/v3/files";async function ue(e,t){const r=`${W}/${e}/permissions`,n=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({type:"anyone",role:"reader"})});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const o=await n.text();throw new Error(`Drive permission error: ${n.status} ${o.slice(0,150)}`)}}async function K(e,t,r="eznote-snip.png"){const n="-------"+Math.random().toString(36).slice(2,12),o={name:r,mimeType:t.type||"image/png"},i=[`\r
--`+n+`\r
`,`Content-Type: application/json; charset=UTF-8\r
\r
`,JSON.stringify(o)].join(""),a=[`\r
--`+n+`\r
`,"Content-Type: "+(t.type||"image/png")+`\r
\r
`].join(""),u=`\r
--`+n+`--\r
`,s=new Blob([i,a,t,u],{type:"multipart/related; boundary="+n}),m=await fetch(le,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/related; boundary="+n},body:s});if(m.status===401)throw new Error("SESSION_EXPIRED");if(!m.ok){const h=await m.text();let g=`Drive upload error: ${m.status}`;try{const E=JSON.parse(h);E.error?.message&&(g=E.error.message)}catch{h&&(g+=" "+h.slice(0,200))}throw new Error(g)}const f=await m.json(),l=f.id;if(!l)throw new Error("No file ID returned from Drive");await ue(l,e);let d=f.webContentLink;if(!d){const h=await fetch(`${W}/${l}?fields=webContentLink`,{headers:{Authorization:`Bearer ${e}`}});h.ok&&(d=(await h.json()).webContentLink)}return d||(d=`https://drive.google.com/uc?export=view&id=${l}`),{fileId:l,imageUrl:d}}const de="snipOverlay.js";async function ge(){const e=await C();if(!e)return null;let t=await O()||await k();return t?{documentId:e,accessToken:t}:null}async function P(e,t,r){w(t,r);try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}try{chrome.runtime.sendMessage({type:"SNIP_OVERLAY_CLOSED"})}catch{}}function he(e){return typeof e!="string"?"Could not add image to document.":e.includes("Unable to download all specified images")?"Google Docs could not use the image link. Try again in a moment or use a smaller selection.":e}async function fe(e,t,r=null,n={}){try{return await me(e,t,r,n)}catch(o){console.error("EZ-Note: Snip and Plug failed",o);const i=o instanceof Error?o.message:String(o);throw await P(e,"Snip and Plug failed",he(i)),o}}async function me(e,t,r=null,n={}){const o=await ge();if(!o){const c=await k(),A=await C();if(!c){await P(e,"Sign in required",'Open EZ-Note and click "Connect Google Docs" to sign in.');return}if(!A){await P(e,"No document selected","Open EZ-Note and select a Google Doc to connect.");return}await P(e,"Connection problem","Open EZ-Note and connect Google Docs again, then try Snip and Plug.");return}try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}await new Promise(c=>setTimeout(c,120));let i;try{i=await chrome.tabs.captureVisibleTab(r??void 0,{format:"png"})}catch(c){console.error("EZ-Note: captureVisibleTab failed",c),await P(e,"Capture failed",c?.message||"Could not capture the tab. Try again.");return}let a;try{a=await chrome.tabs.sendMessage(e,{type:"CROP_IMAGE",dataUrl:i,bounds:t})}catch(c){console.error("EZ-Note: crop message failed",c),await P(e,"Snip failed","Could not process selection. Try again.");return}if(a?.type==="SNIP_ERROR"){await P(e,"Snip failed",a.error||"Crop failed.");return}if(a?.type!=="CROPPED_IMAGE"||!a.base64){await P(e,"Snip failed","No image data received.");return}const u=await fetch(a.base64).then(c=>c.blob()),{documentId:s,accessToken:m}=o,f=n.pageUrl??"",l=n.pageTitle??"Untitled",d=new Date().toISOString(),h=`eznote-snip-${Date.now()}.png`;let g,E=m;try{g=(await K(E,u,h)).imageUrl}catch(c){if(c instanceof Error&&c.message==="SESSION_EXPIRED"){await v(E);const A=await O();if(A){await L(A);try{g=(await K(A,u,h)).imageUrl,E=A}catch(N){console.error("EZ-Note: Drive upload retry failed",N),await P(e,"Upload failed",N instanceof Error?N.message:"Could not upload image. Try again.");return}}else{await P(e,"Session expired",'Open EZ-Note and click "Connect Google Docs" to sign in again.');return}}else{console.error("EZ-Note: Drive upload failed",c),await P(e,"Upload failed",c instanceof Error?c.message:"Could not upload image. Try again.");return}}const b=a.width??400,p=a.height??300,D=72/96,y=Math.max(1,Math.round(b*D*.75)),S=Math.max(1,Math.round(p*D*.75));try{await J(s,E,{imageUrl:g,imageWidthPt:y,imageHeightPt:S,pageUrl:f,pageTitle:l,timestamp:d}),w("Snip and Plug","Screenshot was added to your Google Doc.")}catch(c){if(c instanceof Error&&c.message==="SESSION_EXPIRED"){await v(E);const A=await O();if(A){await L(A);try{await J(s,A,{imageUrl:g,imageWidthPt:y,imageHeightPt:S,pageUrl:f,pageTitle:l,timestamp:d}),w("Snip and Plug","Screenshot was added to your Google Doc.");return}catch(N){throw N}}throw await P(e,"Session expired","Open EZ-Note and sign in again."),c}throw c}}async function pe(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:[de]})}catch(t){console.error("EZ-Note: inject snip overlay failed",t),w("Snip failed","Could not start snipping on this page. Try a different tab or reload.")}}const we="https://docs.googleapis.com/v1/documents",Ee={HEADING_1:"heading1",HEADING_2:"heading2",HEADING_3:"heading3",HEADING_4:"heading4",HEADING_5:"heading5",HEADING_6:"heading6",NORMAL_TEXT:"normal",TITLE:"title",SUBTITLE:"subtitle"};function ye(e,t){if(!e||!t)return null;const r=e[t],n=r?.inlineObjectProperties?.embeddedObject?.imageProperties?.sourceUri||r?.inlineObjectProperties?.embeddedObject?.imageProperties?.contentUri;return typeof n=="string"&&n.length>0?n:null}function Se(e,t){if(!Array.isArray(e))return[];const r=[];for(const n of e){const o=n.paragraph;if(!o)continue;const i=o.paragraphStyle?.namedStyleType,a=Ee[i]??"normal",u=!!o.bullet,s=[];if(Array.isArray(o.elements))for(const f of o.elements){if(f.textRun?.content!==void 0){const l=f.textRun.content,d=f.textRun.textStyle||{};s.push({type:"text",value:l,bold:d.bold===!0,italic:d.italic===!0,underline:d.underline===!0,strikethrough:d.strikethrough===!0})}if(f.inlineObjectElement?.inlineObjectId){const l=ye(t,f.inlineObjectElement.inlineObjectId);l&&s.push({type:"image",url:l})}}(s.some(f=>f.type==="image"||f.type==="text"&&f.value.trim()!=="")||u)&&r.push({type:"paragraph",style:a,listItem:u,children:s})}return r}async function Q(e,t){const r=["title","body.content(paragraph(elements(textRun(content,textStyle(bold,italic,underline,strikethrough)),inlineObjectElement(inlineObjectId)),paragraphStyle(namedStyleType),bullet))","inlineObjects"].join(","),n=`${we}/${e}?fields=${encodeURIComponent(r)}`,o=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401)throw new Error("SESSION_EXPIRED");if(!o.ok){const f=await o.text();let l=`Docs API error: ${o.status}`;try{const d=JSON.parse(f);d.error?.message&&(l=d.error.message)}catch{f&&(l+=` ${f.slice(0,200)}`)}throw new Error(l)}const i=await o.json(),a=i.title??"Untitled",u=i.body?.content??[],s=i.inlineObjects??{},m=Se(u,s);return{title:a,blocks:m}}const G="eznote_snip_overlay_active",B="eznote_snip_tab_id",R=chrome.storage?.session||chrome.storage?.local;function U(e,t=null){if(!R)return Promise.resolve();const r={[G]:!!e,[B]:e&&t!=null?t:null};return R.set(r)}function Ie(){return R?R.get(G).then(e=>!!e[G]):Promise.resolve(!1)}const Te="https://www.googleapis.com/drive/v3/files";function Ae(e){if(!e||typeof e!="string")return null;try{const t=new URL(e);if(t.hostname==="drive.google.com"&&t.pathname==="/uc"){const r=t.searchParams.get("id");if(r)return r}if(t.hostname==="drive.google.com"&&(t.pathname==="/file/d/"||t.pathname.startsWith("/file/d/"))){const r=t.pathname.match(/\/file\/d\/([^/]+)/);if(r)return r[1]}if(t.hostname==="www.googleapis.com"&&t.pathname.startsWith("/drive/v3/files/")){const r=t.pathname.replace(/^\/drive\/v3\/files\//,"").replace(/\?.*$/,"");if(r)return r}if(t.hostname==="lh3.google.com"&&t.pathname.startsWith("/u/0/d/")){const n=t.pathname.replace(/^\/u\/0\/d\//,"").split("=")[0];if(n)return n}return null}catch{return null}}async function Pe(e,t){const r=Ae(e),n=r?`${Te}/${r}?alt=media`:e,o=await fetch(n,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error(`Image fetch: ${o.status}`);const i=await o.blob();if(!i.type||!i.type.startsWith("image/"))throw new Error("Not an image");return new Promise((a,u)=>{const s=new FileReader;s.onload=()=>a(s.result),s.onerror=()=>u(new Error("FileReader failed")),s.readAsDataURL(i)})}async function ee(e,t){const r=async n=>{if(n)try{return await Pe(n,t)}catch{return}};for(const n of e){if(n.type==="image"&&n.url){const o=await r(n.url);o&&(n.url=o)}if(n.type==="paragraph"&&Array.isArray(n.children)){for(const o of n.children)if(o.type==="image"&&o.url){const i=await r(o.url);i&&(o.url=i)}}}}chrome.runtime.onInstalled.addListener(()=>{ae()}),chrome.action.onClicked.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e?.[0];t?.windowId&&chrome.sidePanel.open({windowId:t.windowId}).catch(r=>console.error("EZ-Note: open side panel failed",r))})}),chrome.tabs.onUpdated.addListener((e,t)=>{t.status==="loading"&&R?.get(B).then(r=>{r[B]===e&&U(!1)})}),chrome.contextMenus.onClicked.addListener((e,t)=>{se(e,t).catch(r=>{console.error("EZ-Note: plug it in failed",r)})}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="START_SNIP"){const n=e.tabId??t.tab?.id;return n?pe(n).then(()=>r({ok:!0}),o=>r({error:String(o)})):r({error:"No tab"}),!0}if(e.type==="SNIP_OVERLAY_CREATED"){const n=t.tab?.id;return n&&U(!0,n),!1}if(e.type==="SNIP_BOUNDS"){U(!1);const n=t.tab?.id,o=t.tab?.windowId??null;return n&&e.bounds?fe(n,e.bounds,o,{pageUrl:e.pageUrl,pageTitle:e.pageTitle}).then(()=>r({ok:!0}),i=>r({error:String(i)})):r({error:"No tab or bounds"}),!0}if(e.type==="SNIP_CANCEL")return U(!1),r({ok:!0}),!0;if(e.type==="PLUG_IT_IN"){const n=e.tabId??t.tab?.id;return n?ce(n).then(()=>r({ok:!0}),o=>r({error:String(o)})):r({error:"No tab"}),!0}if(e.type==="GET_SNIP_STATE")return Ie().then(n=>r({active:n})),!0;if(e.type==="SNIP_OVERLAY_CLOSED")return U(!1),!1;if(e.type==="GET_DOC_PREVIEW")return(async()=>{let n;try{const o=await C();if(!o)n={error:"No document selected"};else{let i=await O()||await k();if(!i)n={error:"Sign in required"};else{let a;try{a=await Q(o,i),await ee(a.blocks,i),n={title:a.title,blocks:a.blocks}}catch(u){if(u instanceof Error&&u.message==="SESSION_EXPIRED"){await v(i);const s=await O();s?(await L(s),a=await Q(o,s),await ee(a.blocks,s),n={title:a.title,blocks:a.blocks}):n={error:"Session expired. Sign in again."}}else n={error:u instanceof Error?u.message:String(u)}}}}}catch(o){n={error:o instanceof Error?o.message:"Failed to load preview"}}try{chrome.runtime.sendMessage({type:"DOC_PREVIEW_RESULT",...n})}catch{}})(),!1})})();
