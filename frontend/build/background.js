(function(){"use strict";async function F(e){const t=new Date().toISOString(),n=e.url||"",o=e.title||"Untitled",r={target:{tabId:e.id},func:()=>window.getSelection()?.toString()?.trim()??""},[s]=await chrome.scripting.executeScript(r);return{selectedText:s?.result??"",pageUrl:n,pageTitle:o,timestamp:t}}const A={SELECTED_DOCUMENT_ID:"eznote_selected_document_id",SELECTED_DOCUMENT_NAME:"eznote_selected_document_name",RESEARCH_SNIPS_FOLDER_ID:"eznote_research_snips_folder_id"};function O(){return typeof chrome>"u"||!chrome.storage?.local?null:chrome.storage.local}function k(){const e=O();return e?e.get(A.SELECTED_DOCUMENT_ID).then(t=>t[A.SELECTED_DOCUMENT_ID]||null):Promise.resolve(null)}function oe(){const e=O();return e?e.get(A.SELECTED_DOCUMENT_NAME).then(t=>t[A.SELECTED_DOCUMENT_NAME]||null):Promise.resolve(null)}function V(e,t=""){const n=O();return n?n.set({[A.SELECTED_DOCUMENT_ID]:e,[A.SELECTED_DOCUMENT_NAME]:t||""}):Promise.resolve()}function ie(){const e=O();return e?e.remove([A.SELECTED_DOCUMENT_ID,A.SELECTED_DOCUMENT_NAME]):Promise.resolve()}function se(){const e=O();return e?e.get(A.RESEARCH_SNIPS_FOLDER_ID).then(t=>t[A.RESEARCH_SNIPS_FOLDER_ID]||null):Promise.resolve(null)}function ae(e){const t=O();return t?t.set({[A.RESEARCH_SNIPS_FOLDER_ID]:e}):Promise.resolve()}const I=typeof chrome<"u"&&chrome.identity,U="eznote_access_token";function q(){return!I||!I.getAuthToken?Promise.reject(new Error("Chrome identity API is not available.")):new Promise((e,t)=>{I.getAuthToken({interactive:!0},n=>{if(chrome.runtime.lastError){const o=chrome.runtime.lastError.message||"Failed to get auth token";t(new X(o,chrome.runtime.lastError));return}if(!n){t(new X("No token returned."));return}e(n)})})}function $(){return!I||!I.getAuthToken?Promise.resolve(null):new Promise(e=>{I.getAuthToken({interactive:!1},t=>{if(chrome.runtime.lastError||!t){e(null);return}e(t)})})}function J(e){return!I||!I.removeCachedAuthToken?Promise.resolve():new Promise(t=>{I.removeCachedAuthToken({token:e},()=>{t()})})}function ce(){return!I||!I.clearAllCachedAuthTokens?Promise.resolve():I.clearAllCachedAuthTokens()}function Y(e){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.set({[U]:e})}function le(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve(null):chrome.storage.local.get(U).then(e=>e[U]||null)}function ue(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.remove(U)}class X extends Error{constructor(t,n){super(t),this.name="AuthError",this.chromeError=n}get isUserCancel(){const t=(this.message||"").toLowerCase();return t.includes("cancel")||t.includes("access_denied")||t.includes("user did not approve")}}const L=()=>{};function de(e){const t=`[EZ-Note ${e}]`;return{debug:typeof console<"u"&&console.debug?(...n)=>console.debug(t,...n):L,info:typeof console<"u"&&console.info?(...n)=>console.info(t,...n):L,warn:typeof console<"u"&&console.warn?(...n)=>console.warn(t,...n):L,error:typeof console<"u"&&console.error?(...n)=>console.error(t,...n):L}}const P={bg:de("BG")},fe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKklEQVQ4T2NkYGD4z0ABYBzVMGoB1AIMDAwM/xkZGP4zMjL+Z2RkZPwPAG2cBAdMLsCFAAAAAElFTkSuQmCC";function w(e,t){typeof chrome>"u"||!chrome.notifications?.create||chrome.notifications.create({type:"basic",iconUrl:fe,title:e,message:t})}const he="SESSION_EXPIRED";function W(e){const t=e instanceof Error?e.message:String(e);return t===he||t.includes("401")||t.includes("UNAUTHENTICATED")||t.includes("invalid authentication")||t.includes("Invalid Credentials")||t.includes("Session expired")}async function j(){return await $().catch(()=>null)||await le()||null}async function ge(e={interactive:!1}){if(e.interactive){const n=await q();return await Y(n),n}const t=await j();if(!t)throw new Error("Not signed in");return t}async function R(e){let t=await j();if(!t)throw P.bg.warn("withTokenRetry: no token"),new Error("Sign in required");try{return await e(t)}catch(n){if(!W(n))throw n;P.bg.info("Auth error, invalidating cache and retrying once"),await J(t);const o=await $().catch(()=>null);if(!o)throw await G(),w("Session expired","Please open the extension and connect Google Docs again."),new Error("Session expired");await Y(o);try{return await e(o)}catch(r){throw W(r)&&(await G(),w("Session expired","Please open the extension and connect Google Docs again.")),r}}}async function G(){await ue();try{await ce()}catch{}await ie(),P.bg.info("Auth state cleared")}async function me(){await G()}const pe="https://docs.googleapis.com/v1/documents",Ee={HEADING_1:"heading1",HEADING_2:"heading2",HEADING_3:"heading3",HEADING_4:"heading4",HEADING_5:"heading5",HEADING_6:"heading6",NORMAL_TEXT:"normal",TITLE:"title",SUBTITLE:"subtitle"};function we(e,t){if(!e||!t)return null;const n=e[t],o=n?.inlineObjectProperties?.embeddedObject?.imageProperties?.sourceUri||n?.inlineObjectProperties?.embeddedObject?.imageProperties?.contentUri;return typeof o=="string"&&o.length>0?o:null}function Se(e,t){if(!Array.isArray(e))return[];const n=[];for(const o of e){const r=o.paragraph;if(!r)continue;const s=r.paragraphStyle?.namedStyleType,i=Ee[s]??"normal",a=!!r.bullet,c=[];if(Array.isArray(r.elements))for(const u of r.elements){if(u.textRun?.content!==void 0){const h=u.textRun.content,d=u.textRun.textStyle||{};c.push({type:"text",value:h,bold:d.bold===!0,italic:d.italic===!0,underline:d.underline===!0,strikethrough:d.strikethrough===!0})}if(u.inlineObjectElement?.inlineObjectId){const h=we(t,u.inlineObjectElement.inlineObjectId);h&&c.push({type:"image",url:h})}}(c.some(u=>u.type==="image"||u.type==="text"&&u.value.trim()!=="")||a)&&n.push({type:"paragraph",style:i,listItem:a,children:c})}return n}async function ye(e,t){const n=["title","body.content(paragraph(elements(textRun(content,textStyle(bold,italic,underline,strikethrough)),inlineObjectElement(inlineObjectId)),paragraphStyle(namedStyleType),bullet))","inlineObjects"].join(","),o=`${pe}/${e}?fields=${encodeURIComponent(n)}`,r=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const u=await r.text();let h=`Docs API error: ${r.status}`;try{const d=JSON.parse(u);d.error?.message&&(h=d.error.message)}catch{u&&(h+=` ${u.slice(0,200)}`)}throw new Error(h)}const s=await r.json(),i=s.title??"Untitled",a=s.body?.content??[],c=s.inlineObjects??{},m=Se(a,c);return{title:i,blocks:m}}const B="https://docs.googleapis.com/v1/documents";async function Z(e,t){const n=`${B}/${e}?fields=body.content(endIndex)`,o=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401)throw new Error("SESSION_EXPIRED");if(!o.ok){const i=await o.text();let a=`Docs API error: ${o.status}`;try{const c=JSON.parse(i);c.error?.message&&(a=c.error.message)}catch{i&&(a+=` ${i.slice(0,200)}`)}throw new Error(a)}const s=(await o.json()).body?.content||[];return s.length===0?0:Math.max(...s.map(i=>i.endIndex||0))}const K=/^[\s\t]*([•·▪◦\-*]\s+)/,Q=/^[\s\t]*(\d+[.)]\s+)/;function Te(e,t,n,o){const r=e.split(/\n/),s=[],i=[],a=[];let c=1;for(const h of r){const d=h.match(K),g=!d&&h.match(Q);let f=h,T=h.length+1;d?(f=h.replace(K,"").trimStart(),f=f||" ",T=f.length+1,i.push({start:c,end:c+f.length+1})):g?(f=h.replace(Q,"").trimStart(),f=f||" ",T=f.length+1,a.push({start:c,end:c+f.length+1})):f=f||" ",s.push(f),c+=T}const m=s.join(`
`);return{textToInsert:`
`+m+t+n+o,bulletRanges:i,numberedRanges:a,quoteLen:m.length}}async function _e(e,t,n){const{selectedText:o,pageUrl:r,pageTitle:s,timestamp:i}=n,a=s||"Untitled",c=o||"",m=`
Source: `,u=` ${i}`,{textToInsert:h,bulletRanges:d,numberedRanges:g,quoteLen:f}=Te(c,m,a,u),T=[{insertText:{endOfSegmentLocation:{segmentId:""},text:h}}],_=`${B}/${e}:batchUpdate`;let p=await fetch(_,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:T})});if(p.status===401)throw new Error("SESSION_EXPIRED");if(!p.ok){const S=await p.text();let y=`Docs API error: ${p.status}`;try{const D=JSON.parse(S);D.error?.message&&(y=D.error.message)}catch{S&&(y+=` ${S.slice(0,200)}`)}throw new Error(y)}const C=await Z(e,t),l=C-h.length,E=[];if(d.length>0){const S=d[0],y=d[d.length-1];E.push({createParagraphBullets:{range:{startIndex:l+S.start,endIndex:l+y.end},bulletPreset:"BULLET_DISC_CIRCLE_SQUARE"}})}if(g.length>0){const S=g[0],y=g[g.length-1];E.push({createParagraphBullets:{range:{startIndex:l+S.start,endIndex:l+y.end},bulletPreset:"NUMBERED_DECIMAL_ALPHA_ROMAN"}})}if(E.length>0){if(p=await fetch(_,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:E})}),p.status===401)throw new Error("SESSION_EXPIRED");if(!p.ok){const S=await p.text();let y=`Docs API error: ${p.status}`;try{const D=JSON.parse(S);D.error?.message&&(y=D.error.message)}catch{S&&(y+=` ${S.slice(0,200)}`)}throw new Error(y)}}const b=h.length,re=C-b+1+f+m.length,tt=re+a.length,nt=[{updateTextStyle:{range:{startIndex:re,endIndex:tt},textStyle:{link:{url:r||"#"}},fields:"link"}}];if(p=await fetch(_,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:nt})}),p.status===401)throw new Error("SESSION_EXPIRED");if(!p.ok){const S=await p.text();let y=`Docs API error: ${p.status}`;try{const D=JSON.parse(S);D.error?.message&&(y=D.error.message)}catch{S&&(y+=` ${S.slice(0,200)}`)}throw new Error(y)}}async function Ie(e,t,n){const{imageUrl:o,imageWidthPt:r,imageHeightPt:s,pageUrl:i,pageTitle:a,timestamp:c}=n,m=a||"Untitled",u=`
Source: `+m+" "+c,h=[{insertInlineImage:{uri:o,objectSize:{width:{magnitude:r,unit:"PT"},height:{magnitude:s,unit:"PT"}},endOfSegmentLocation:{segmentId:""}}},{insertText:{endOfSegmentLocation:{segmentId:""},text:u}}],d=`${B}/${e}:batchUpdate`;let g=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:h})});if(g.status===401)throw new Error("SESSION_EXPIRED");if(!g.ok){const l=await g.text();let E=`Docs API error: ${g.status}`;try{const b=JSON.parse(l);b.error?.message&&(E=b.error.message)}catch{l&&(E+=` ${l.slice(0,200)}`)}throw new Error(E)}const f=await Z(e,t),T=u.length,_=f-T+9,p=_+m.length,C=[{updateTextStyle:{range:{startIndex:_,endIndex:p},textStyle:{link:{url:i||"#"}},fields:"link"}}];if(g=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:C})}),g.status===401)throw new Error("SESSION_EXPIRED");if(!g.ok){const l=await g.text();let E=`Docs API error: ${g.status}`;try{const b=JSON.parse(l);b.error?.message&&(E=b.error.message)}catch{l&&(E+=` ${l.slice(0,200)}`)}throw new Error(E)}}const Ae="https://www.googleapis.com/drive/v3/files",be="application/vnd.google-apps.document";async function ee(e){const t=e||await q(),n=`${Ae}?q=${encodeURIComponent(`mimeType='${be}'`)}&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc&pageSize=100`,o=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401){await J(t);const i=await $();if(i)return ee(i);throw new Error("Session expired. Please sign in again.")}if(!o.ok){const i=await o.text();let a=`Drive API error: ${o.status}`;try{const c=JSON.parse(i);c.error?.message&&(a=c.error.message)}catch{i&&(a+=` ${i.slice(0,200)}`)}throw new Error(a)}return((await o.json()).files||[]).map(i=>({id:i.id,name:i.name||"Untitled",modifiedTime:i.modifiedTime}))}const De="https://www.googleapis.com/drive/v3/files";function Pe(e){if(!e||typeof e!="string")return null;try{const t=new URL(e);if(t.hostname==="drive.google.com"&&t.pathname==="/uc")return t.searchParams.get("id");if(t.hostname==="drive.google.com"&&t.pathname.startsWith("/file/d/")){const n=t.pathname.match(/\/file\/d\/([^/]+)/);return n?n[1]:null}if(t.hostname==="www.googleapis.com"&&t.pathname.startsWith("/drive/v3/files/"))return t.pathname.replace(/^\/drive\/v3\/files\//,"").replace(/\?.*$/,"");if(t.hostname==="lh3.google.com"&&t.pathname.startsWith("/u/0/d/"))return t.pathname.replace(/^\/u\/0\/d\//,"").split("=")[0]}catch{}return null}async function Ne(e,t){const n=Pe(e),o=n?`${De}/${n}?alt=media`:e,r=await fetch(o,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw new Error(`Image fetch: ${r.status}`);const s=await r.blob();if(!s.type||!s.type.startsWith("image/"))throw new Error("Not an image");return new Promise((i,a)=>{const c=new FileReader;c.onload=()=>i(c.result),c.onerror=()=>a(new Error("FileReader failed")),c.readAsDataURL(s)})}async function Oe(e,t){const n=async o=>{if(o)try{return await Ne(o,t)}catch{return}};for(const o of e){if(o.type==="image"&&o.url){const r=await n(o.url);r&&(o.url=r)}if(o.type==="paragraph"&&Array.isArray(o.children)){for(const r of o.children)if(r.type==="image"&&r.url){const s=await n(r.url);s&&(r.url=s)}}}}const Ce=ye,Re=_e,xe=Ie,ve=ee;function ke(e){const{selectedText:t="",pageTitle:n="Untitled",timestamp:o}=e,r=n||"Untitled";return`
`+t.trim()+`
Source: `+r+" "+(o||new Date().toISOString())}async function Ue(e,t,n){if(!e||!t||typeof n!="string")return!1;const o="https://docs.google.com/document/d/"+e+"/";let r;try{r=await chrome.tabs.query({url:o+"*"})}catch{return!1}const s=r&&r[0];if(!s?.id)return!1;try{await chrome.scripting.executeScript({target:{tabId:t},func:i=>typeof navigator.clipboard<"u"&&navigator.clipboard.writeText?navigator.clipboard.writeText(i):Promise.reject(new Error("Clipboard not available")),args:[n]})}catch{return!1}try{return await chrome.tabs.update(s.id,{active:!0}),await new Promise(a=>setTimeout(a,150)),(await chrome.tabs.sendMessage(s.id,{type:"TRIGGER_PASTE"}))?.ok===!0}catch{return!1}}async function Le(e,t,n,o){if(!e||!t||!n)return!1;const r="https://docs.google.com/document/d/"+e+"/";let s;try{s=await chrome.tabs.query({url:r+"*"})}catch{return!1}const i=s&&s[0];if(!i?.id)return!1;try{await chrome.scripting.executeScript({target:{tabId:t},func:async a=>{const m=await(await fetch(a)).blob();await navigator.clipboard.write([new ClipboardItem({"image/png":m})])},args:[n]})}catch{return!1}try{return await chrome.tabs.update(i.id,{active:!0}),await new Promise(a=>setTimeout(a,150)),await chrome.tabs.sendMessage(i.id,{type:"TRIGGER_PASTE"}),o&&(await chrome.scripting.executeScript({target:{tabId:t},func:a=>navigator.clipboard.writeText(a),args:[o]}),await new Promise(a=>setTimeout(a,80)),await chrome.tabs.sendMessage(i.id,{type:"TRIGGER_PASTE"})),!0}catch{return!1}}function Me(e){const t=e instanceof Error?e.message:String(e);return t.includes("Unable to download all specified images")||t.includes("download")?"Could not add text to the document. Try again in a moment.":t.includes("Session expired")||t.includes("Sign in required")?'Open the extension and click "Connect Google Docs" to sign in again.':t||"Something went wrong. Try again."}async function te(e,t){const n=await k();if(!n){w("No document selected","Open the EZ-NoteTaker extension and select a Google Doc to connect.");return}const o=ke(e);if(t&&await Ue(n,t,o)){w("Plugged in","Added at cursor in your open doc.");return}try{await R(r=>Re(n,r,e)),w("Plugged in","Highlight was added to your connected Google Doc.")}catch(r){if((r instanceof Error?r.message:String(r)).includes("Sign in required")){w("Sign in required",'Open the EZ-NoteTaker extension and click "Connect Google Docs" to sign in.');return}w("Could not plug in",Me(r))}}const ne="eznote-plug-it-in";function $e(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:ne,title:"Plug it in",contexts:["selection"]},()=>{chrome.runtime.lastError&&console.error("EZ-NoteTaker: context menu create failed",chrome.runtime.lastError)})})}async function je(e,t){if(!(e.menuItemId!==ne||!t?.id))try{const n=await F(t);if(!n.selectedText?.trim()){w("No text selected",'Select some text on the page, then right‑click and choose "Plug it in".');return}await te(n,t.id)}catch(n){console.error("EZ-NoteTaker: plug it in failed",n),w("Could not plug in",n instanceof Error?n.message:"Something went wrong. Try again.")}}async function Ge(e){if(e)try{const t=await chrome.tabs.get(e),n=await F(t);if(!n.selectedText?.trim()){w("No text selected",'Select some text on the page, then click "Plug it in" in the extension.');return}await te(n,t.id)}catch(t){console.error("EZ-NoteTaker: plug it in failed",t),w("Could not plug in",t instanceof Error?t.message:"Something went wrong. Try again.")}}const M="https://www.googleapis.com/drive/v3/files",Be="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webContentLink,webViewLink",ze="application/vnd.google-apps.folder",He="application/vnd.google-apps.document",Fe="Research Snips";async function Ve(e,t){const n=await fetch(`${M}/${e}/permissions`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({type:"anyone",role:"reader"})});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const o=await n.text();throw new Error(`Drive permission error: ${n.status} ${o.slice(0,150)}`)}}async function qe(e){let t=await se();if(t)return t;const n=await fetch(M,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:Fe,mimeType:ze})});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const r=await n.text();let s=`Drive create folder error: ${n.status}`;try{const i=JSON.parse(r);i.error?.message&&(s=i.error.message)}catch{}throw new Error(s)}if(t=(await n.json()).id,!t)throw new Error("No folder ID returned from Drive");return await ae(t),P.bg.info("Created Research Snips folder",t),t}async function Je(e,t,n="eznote-snip.png",o=null){const r="-------"+Math.random().toString(36).slice(2,12),s={name:n,mimeType:t.type||"image/png"};o&&(s.parents=[o]);const i=[`\r
--`+r+`\r
`,`Content-Type: application/json; charset=UTF-8\r
\r
`,JSON.stringify(s)].join(""),a=[`\r
--`+r+`\r
`,"Content-Type: "+(t.type||"image/png")+`\r
\r
`].join(""),c=`\r
--`+r+`--\r
`,m=new Blob([i,a,t,c],{type:"multipart/related; boundary="+r}),u=await fetch(Be,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/related; boundary="+r},body:m});if(u.status===401)throw new Error("SESSION_EXPIRED");if(!u.ok){const f=await u.text();let T=`Drive upload error: ${u.status}`;try{const _=JSON.parse(f);_.error?.message&&(T=_.error.message)}catch{f&&(T+=" "+f.slice(0,200))}throw new Error(T)}const h=await u.json(),d=h.id;if(!d)throw new Error("No file ID returned from Drive");await Ve(d,e);let g=h.webContentLink;if(!g){const f=await fetch(`${M}/${d}?fields=webContentLink`,{headers:{Authorization:`Bearer ${e}`}});f.ok&&(g=(await f.json()).webContentLink)}return g||(g=`https://drive.google.com/uc?export=view&id=${d}`),{fileId:d,imageUrl:g}}async function Ye(e,t="Untitled"){const n=await fetch(M,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:t.trim()||"Untitled",mimeType:He})});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const s=await n.text();let i=`Drive create doc error: ${n.status}`;try{const a=JSON.parse(s);a.error?.message&&(i=a.error.message)}catch{}throw new Error(i)}const o=await n.json(),r=o.id;if(!r)throw new Error("No document ID returned from Drive");return{id:r,name:o.name||t||"Untitled"}}const Xe="snipOverlay.js";async function N(e,t,n){w(t,n);try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}try{chrome.runtime.sendMessage({type:"SNIP_OVERLAY_CLOSED"})}catch{}}function We(e){return typeof e!="string"?"Could not add image to document.":e.includes("Unable to download all specified images")?"Google Docs could not use the image link. Try again in a moment or use a smaller selection.":e}async function Ze(e,t,n=null,o={}){const r=await k();if(!r){await N(e,"No document selected","Open EZ-NoteTaker and select a Google Doc to connect.");return}try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}await new Promise(l=>setTimeout(l,120));let s;try{s=await chrome.tabs.captureVisibleTab(n??void 0,{format:"png"})}catch(l){await N(e,"Capture failed",l?.message||"Could not capture the tab. Try again.");return}let i;try{i=await chrome.tabs.sendMessage(e,{type:"CROP_IMAGE",dataUrl:s,bounds:t})}catch{await N(e,"Snip failed","Could not process selection. Try again.");return}if(i?.type==="SNIP_ERROR"){await N(e,"Snip failed",i.error||"Crop failed.");return}if(i?.type!=="CROPPED_IMAGE"||!i.base64){await N(e,"Snip failed","No image data received.");return}const a=o.pageUrl??"",c=o.pageTitle??"Untitled",m=new Date().toISOString(),u=`
Source: `+c+" "+m;if(await Le(r,e,i.base64,u)){try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}w("Snip and Plug","Screenshot added at cursor in your open doc.");return}const d=await fetch(i.base64).then(l=>l.blob()),g=`eznote-snip-${Date.now()}.png`,f=i.width??400,T=i.height??300,_=72/96,p=Math.max(1,Math.round(f*_*.75)),C=Math.max(1,Math.round(T*_*.75));try{await R(async l=>{const E=await qe(l),{imageUrl:b}=await Je(l,d,g,E);await xe(r,l,{imageUrl:b,imageWidthPt:p,imageHeightPt:C,pageUrl:a,pageTitle:c,timestamp:m})}),w("Snip and Plug","Screenshot was added to your Google Doc.")}catch(l){const E=l instanceof Error?l.message:String(l);if(E.includes("Sign in required")){await N(e,"Sign in required",'Open EZ-NoteTaker and click "Connect Google Docs" to sign in.');return}await N(e,"Snip and Plug failed",We(E))}}async function Ke(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:[Xe]})}catch{w("Snip failed","Could not start snipping on this page. Try a different tab or reload.")}}async function Qe(e,t){const n=e?.type;if(n==="AUTH_GET_STATUS"){const o=await j(),r=await k(),s=await oe();return{sendResponse:!0,response:{connected:!!o,documentId:r||null,documentName:s||null}}}if(n==="AUTH_CONNECT")try{return await ge({interactive:!0}),{sendResponse:!0,response:{success:!0}}}catch(o){return P.bg.warn("AUTH_CONNECT failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(n==="AUTH_DISCONNECT")return await me(),{sendResponse:!0,response:{success:!0}};if(n==="DOCS_LIST")try{return{sendResponse:!0,response:{success:!0,docs:await R(r=>ve(r))}}}catch(o){return P.bg.warn("DOCS_LIST failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(n==="DOCS_SET_SELECTED"){const{documentId:o,documentName:r}=e;return o?(await V(o,r||""),{sendResponse:!0,response:{success:!0}}):{sendResponse:!0,response:{success:!1,error:"Missing documentId"}}}if(n==="DOCS_CREATE"){const o=typeof e.name=="string"?e.name.trim():"Untitled";try{const r=await R(s=>Ye(s,o||"Untitled"));return await V(r.id,r.name),{sendResponse:!0,response:{success:!0,doc:{id:r.id,name:r.name}}}}catch(r){return P.bg.warn("DOCS_CREATE failed",r),{sendResponse:!0,response:{success:!1,error:r instanceof Error?r.message:String(r)}}}}return n==="GET_DOC_PREVIEW"?((async()=>{let o;try{const r=await k();if(!r)o={error:"No document selected"};else{const s=await R(async i=>{const a=await Ce(r,i);return await Oe(a.blocks,i),a});o={title:s.title,blocks:s.blocks}}}catch(r){o={error:r instanceof Error?r.message:"Failed to load preview"}}try{chrome.runtime.sendMessage({type:"DOC_PREVIEW_RESULT",...o})}catch{}})(),{sendResponse:!1}):null}const z="eznote_snip_overlay_active",H="eznote_snip_tab_id",x=chrome.storage?.session||chrome.storage?.local;function v(e,t=null){return x?x.set({[z]:!!e,[H]:e&&t!=null?t:null}):Promise.resolve()}function et(){return x?x.get(z).then(e=>!!e[z]):Promise.resolve(!1)}chrome.runtime.onInstalled.addListener(()=>{$e()}),chrome.action.onClicked.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e?.[0];t?.windowId&&chrome.sidePanel.open({windowId:t.windowId}).catch(n=>P.bg.error("open side panel failed",n))})}),chrome.tabs.onUpdated.addListener((e,t)=>{t.status==="loading"&&x?.get(H).then(n=>{n[H]===e&&v(!1)})}),chrome.contextMenus.onClicked.addListener((e,t)=>{je(e,t).catch(n=>P.bg.error("plug it in failed",n))}),chrome.runtime.onMessage.addListener((e,t,n)=>{if(["AUTH_GET_STATUS","AUTH_CONNECT","AUTH_DISCONNECT","DOCS_LIST","DOCS_SET_SELECTED","DOCS_CREATE","GET_DOC_PREVIEW"].includes(e?.type))return Qe(e).then(r=>{r&&r.sendResponse&&n(r.response)}).catch(r=>{P.bg.error("messageHub",r),n({error:r instanceof Error?r.message:String(r)})}),!0;if(e.type==="START_SNIP"){const r=e.tabId??t.tab?.id;return r?Ke(r).then(()=>n({ok:!0}),s=>n({error:String(s)})):n({error:"No tab"}),!0}if(e.type==="SNIP_OVERLAY_CREATED"){const r=t.tab?.id;return r&&v(!0,r),!1}if(e.type==="SNIP_BOUNDS"){v(!1);const r=t.tab?.id,s=t.tab?.windowId??null;return r&&e.bounds?Ze(r,e.bounds,s,{pageUrl:e.pageUrl,pageTitle:e.pageTitle}).then(()=>n({ok:!0}),i=>n({error:String(i)})):n({error:"No tab or bounds"}),!0}if(e.type==="SNIP_CANCEL")return v(!1),n({ok:!0}),!0;if(e.type==="PLUG_IT_IN"){const r=e.tabId??t.tab?.id;return r?Ge(r).then(()=>n({ok:!0}),s=>n({error:String(s)})):n({error:"No tab"}),!0}return e.type==="GET_SNIP_STATE"?(et().then(r=>n({active:r})),!0):(e.type==="SNIP_OVERLAY_CLOSED"&&v(!1),!1)})})();
