(function(){"use strict";async function B(e){const t=new Date().toISOString(),r=e.url||"",o=e.title||"Untitled",n={target:{tabId:e.id},func:()=>window.getSelection()?.toString()?.trim()??""},[s]=await chrome.scripting.executeScript(n);return{selectedText:s?.result??"",pageUrl:r,pageTitle:o,timestamp:t}}const P={SELECTED_DOCUMENT_ID:"eznote_selected_document_id",SELECTED_DOCUMENT_NAME:"eznote_selected_document_name",RESEARCH_SNIPS_FOLDER_ID:"eznote_research_snips_folder_id"};function R(){return typeof chrome>"u"||!chrome.storage?.local?null:chrome.storage.local}function U(){const e=R();return e?e.get(P.SELECTED_DOCUMENT_ID).then(t=>t[P.SELECTED_DOCUMENT_ID]||null):Promise.resolve(null)}function ie(){const e=R();return e?e.get(P.SELECTED_DOCUMENT_NAME).then(t=>t[P.SELECTED_DOCUMENT_NAME]||null):Promise.resolve(null)}function X(e,t=""){const r=R();return r?r.set({[P.SELECTED_DOCUMENT_ID]:e,[P.SELECTED_DOCUMENT_NAME]:t||""}):Promise.resolve()}function ce(){const e=R();return e?e.remove([P.SELECTED_DOCUMENT_ID,P.SELECTED_DOCUMENT_NAME]):Promise.resolve()}function le(){const e=R();return e?e.get(P.RESEARCH_SNIPS_FOLDER_ID).then(t=>t[P.RESEARCH_SNIPS_FOLDER_ID]||null):Promise.resolve(null)}function ue(e){const t=R();return t?t.set({[P.RESEARCH_SNIPS_FOLDER_ID]:e}):Promise.resolve()}const N=typeof chrome<"u"&&chrome.identity,$="eznote_access_token";function Y(){return!N||!N.getAuthToken?Promise.reject(new Error("Chrome identity API is not available.")):new Promise((e,t)=>{N.getAuthToken({interactive:!0},r=>{if(chrome.runtime.lastError){const o=chrome.runtime.lastError.message||"Failed to get auth token";t(new K(o,chrome.runtime.lastError));return}if(!r){t(new K("No token returned."));return}e(r)})})}function H(){return!N||!N.getAuthToken?Promise.resolve(null):new Promise(e=>{N.getAuthToken({interactive:!1},t=>{if(chrome.runtime.lastError||!t){e(null);return}e(t)})})}function W(e){return!N||!N.removeCachedAuthToken?Promise.resolve():new Promise(t=>{N.removeCachedAuthToken({token:e},()=>{t()})})}function de(){return!N||!N.clearAllCachedAuthTokens?Promise.resolve():N.clearAllCachedAuthTokens()}function Z(e){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.set({[$]:e})}function fe(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve(null):chrome.storage.local.get($).then(e=>e[$]||null)}function he(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.remove($)}class K extends Error{constructor(t,r){super(t),this.name="AuthError",this.chromeError=r}get isUserCancel(){const t=(this.message||"").toLowerCase();return t.includes("cancel")||t.includes("access_denied")||t.includes("user did not approve")}}const M=()=>{};function ge(e){const t=`[EZ-Note ${e}]`;return{debug:typeof console<"u"&&console.debug?(...r)=>console.debug(t,...r):M,info:typeof console<"u"&&console.info?(...r)=>console.info(t,...r):M,warn:typeof console<"u"&&console.warn?(...r)=>console.warn(t,...r):M,error:typeof console<"u"&&console.error?(...r)=>console.error(t,...r):M}}const b={bg:ge("BG")},me="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKklEQVQ4T2NkYGD4z0ABYBzVMGoB1AIMDAwM/xkZGP4zMjL+Z2RkZPwPAG2cBAdMLsCFAAAAAElFTkSuQmCC";function I(e,t){typeof chrome>"u"||!chrome.notifications?.create||chrome.notifications.create({type:"basic",iconUrl:me,title:e,message:t})}const pe="SESSION_EXPIRED";function Q(e){const t=e instanceof Error?e.message:String(e);return t===pe||t.includes("401")||t.includes("UNAUTHENTICATED")||t.includes("invalid authentication")||t.includes("Invalid Credentials")||t.includes("Session expired")}async function z(){return await H().catch(()=>null)||await fe()||null}async function Ee(e={interactive:!1}){if(e.interactive){const r=await Y();return await Z(r),r}const t=await z();if(!t)throw new Error("Not signed in");return t}async function C(e){let t=await z();if(!t)throw b.bg.warn("withTokenRetry: no token"),new Error("Sign in required");try{return await e(t)}catch(r){if(!Q(r))throw r;b.bg.info("Auth error, invalidating cache and retrying once"),await W(t);const o=await H().catch(()=>null);if(!o)throw await q(),I("Session expired","Please open the extension and connect Google Docs again."),new Error("Session expired");await Z(o);try{return await e(o)}catch(n){throw Q(n)&&(await q(),I("Session expired","Please open the extension and connect Google Docs again.")),n}}}async function q(){await he();try{await de()}catch{}await ce(),b.bg.info("Auth state cleared")}async function we(){await q()}const Se="https://docs.googleapis.com/v1/documents",ye={HEADING_1:"heading1",HEADING_2:"heading2",HEADING_3:"heading3",HEADING_4:"heading4",HEADING_5:"heading5",HEADING_6:"heading6",NORMAL_TEXT:"normal",TITLE:"title",SUBTITLE:"subtitle"};function Te(e,t){if(!e||!t)return null;const r=e[t],o=r?.inlineObjectProperties?.embeddedObject?.imageProperties?.sourceUri||r?.inlineObjectProperties?.embeddedObject?.imageProperties?.contentUri;return typeof o=="string"&&o.length>0?o:null}function _e(e,t){if(!Array.isArray(e))return[];const r=[];for(const o of e){const n=o.paragraph;if(!n)continue;const s=n.paragraphStyle?.namedStyleType,a=ye[s]??"normal",i=!!n.bullet,l=[];if(Array.isArray(n.elements))for(const d of n.elements){if(d.textRun?.content!==void 0){const g=d.textRun.content,c=d.textRun.textStyle||{};l.push({type:"text",value:g,bold:c.bold===!0,italic:c.italic===!0,underline:c.underline===!0,strikethrough:c.strikethrough===!0})}if(d.inlineObjectElement?.inlineObjectId){const g=Te(t,d.inlineObjectElement.inlineObjectId);g&&l.push({type:"image",url:g})}}(l.some(d=>d.type==="image"||d.type==="text"&&d.value.trim()!=="")||i)&&r.push({type:"paragraph",style:a,listItem:i,children:l})}return r}async function Ie(e,t){const r=["title","body.content(paragraph(elements(textRun(content,textStyle(bold,italic,underline,strikethrough)),inlineObjectElement(inlineObjectId)),paragraphStyle(namedStyleType),bullet))","inlineObjects"].join(","),o=`${Se}/${e}?fields=${encodeURIComponent(r)}`,n=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const d=await n.text();let g=`Docs API error: ${n.status}`;try{const c=JSON.parse(d);c.error?.message&&(g=c.error.message)}catch{d&&(g+=` ${d.slice(0,200)}`)}throw new Error(g)}const s=await n.json(),a=s.title??"Untitled",i=s.body?.content??[],l=s.inlineObjects??{},p=_e(i,l);return{title:a,blocks:p}}const L="https://docs.googleapis.com/v1/documents";async function ee(e,t){const r=`${L}/${e}?fields=body.content(endIndex)`,o=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401)throw new Error("SESSION_EXPIRED");if(!o.ok){const a=await o.text();let i=`Docs API error: ${o.status}`;try{const l=JSON.parse(a);l.error?.message&&(i=l.error.message)}catch{a&&(i+=` ${a.slice(0,200)}`)}throw new Error(i)}const s=(await o.json()).body?.content||[];return s.length===0?0:Math.max(...s.map(a=>a.endIndex||0))}const te=/^[\s\t]*([•·▪◦\-*]\s+)/,ne=/^[\s\t]*(\d+[.)]\s+)/;function re(e,t,r,o){const n=e.split(/\n/),s=[],a=[],i=[];let l=1;for(const g of n){const c=g.match(te),f=!c&&g.match(ne);let u=g,_=g.length+1;c?(u=g.replace(te,"").trimStart(),u=u||" ",_=u.length+1,a.push({start:l,end:l+u.length+1})):f?(u=g.replace(ne,"").trimStart(),u=u||" ",_=u.length+1,i.push({start:l,end:l+u.length+1})):u=u||" ",s.push(u),l+=_}const p=s.join(`
`);return{textToInsert:`
`+p+t+r+o,bulletRanges:a,numberedRanges:i,quoteLen:p.length}}async function Ae(e,t,r){const{selectedText:o,pageUrl:n,pageTitle:s,timestamp:a}=r,i=s||"Untitled",l=o||"",p=`
Source: `,d=` ${a}`,{textToInsert:g,bulletRanges:c,numberedRanges:f,quoteLen:u}=re(l,p,i,d),_=[{insertText:{endOfSegmentLocation:{segmentId:""},text:g}}],S=`${L}/${e}:batchUpdate`;let m=await fetch(S,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:_})});if(m.status===401)throw new Error("SESSION_EXPIRED");if(!m.ok){const E=await m.text();let T=`Docs API error: ${m.status}`;try{const O=JSON.parse(E);O.error?.message&&(T=O.error.message)}catch{E&&(T+=` ${E.slice(0,200)}`)}throw new Error(T)}const y=await ee(e,t),h=y-g.length,w=[];if(c.length>0){const E=c[0],T=c[c.length-1];w.push({createParagraphBullets:{range:{startIndex:h+E.start,endIndex:h+T.end},bulletPreset:"BULLET_DISC_CIRCLE_SQUARE"}})}if(f.length>0){const E=f[0],T=f[f.length-1];w.push({createParagraphBullets:{range:{startIndex:h+E.start,endIndex:h+T.end},bulletPreset:"NUMBERED_DECIMAL_ALPHA_ROMAN"}})}if(w.length>0){if(m=await fetch(S,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:w})}),m.status===401)throw new Error("SESSION_EXPIRED");if(!m.ok){const E=await m.text();let T=`Docs API error: ${m.status}`;try{const O=JSON.parse(E);O.error?.message&&(T=O.error.message)}catch{E&&(T+=` ${E.slice(0,200)}`)}throw new Error(T)}}const A=g.length,j=y-A+1+u+p.length,V=j+i.length,D=[{updateTextStyle:{range:{startIndex:j,endIndex:V},textStyle:{link:{url:n||"#"}},fields:"link"}}];if(m=await fetch(S,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:D})}),m.status===401)throw new Error("SESSION_EXPIRED");if(!m.ok){const E=await m.text();let T=`Docs API error: ${m.status}`;try{const O=JSON.parse(E);O.error?.message&&(T=O.error.message)}catch{E&&(T+=` ${E.slice(0,200)}`)}throw new Error(T)}}const be=new Set(["HEADING_1","HEADING_2","HEADING_3","HEADING_4","HEADING_5","HEADING_6","TITLE","SUBTITLE"]);async function De(e,t){const r=["body.content(startIndex,endIndex,paragraph(paragraphStyle(namedStyleType),elements(textRun(content))))"].join(","),o=`${L}/${e}?fields=${encodeURIComponent(r)}`,n=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const c=await n.text();let f=`Docs API error: ${n.status}`;try{const u=JSON.parse(c);u.error?.message&&(f=u.error.message)}catch{c&&(f+=` ${c.slice(0,200)}`)}throw new Error(f)}const a=(await n.json()).body?.content||[];let i=1,l=1;const p=[],d=[];for(const c of a){const f=c.endIndex??c.startIndex??0;f>i&&(i=f);const u=c.paragraph;if(u&&be.has(u.paragraphStyle?.namedStyleType)){if(p.length>0){const m=Math.max(1,l-1);d[d.length-1]=m}let S="";if(Array.isArray(u.elements))for(const m of u.elements)m.textRun?.content&&(S+=m.textRun.content);S=S.replace(/\n/g," ").trim().slice(0,60)||"(unnamed)",p.push(S),d.push(null)}else l=f}d.length>0&&(d[d.length-1]=Math.max(1,l-1));const g=[{label:"At the beginning",index:1}];for(let c=0;c<p.length;c++){const f=d[c]!=null?d[c]:i;g.push({label:"End of section: "+p[c],index:f})}return g.push({label:"At the end",index:i}),g}async function Ne(e,t,r,o){const{selectedText:n,pageUrl:s,pageTitle:a,timestamp:i}=r,l=a||"Untitled",p=n||"",d=`
Source: `,g=` ${i}`,{textToInsert:c,bulletRanges:f,numberedRanges:u,quoteLen:_}=re(p,d,l,g),S=[{insertText:{location:{index:o},text:c}}],m=`${L}/${e}:batchUpdate`;let y=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:S})});if(y.status===401)throw new Error("SESSION_EXPIRED");if(!y.ok){const D=await y.text();let E=`Docs API error: ${y.status}`;try{const T=JSON.parse(D);T.error?.message&&(E=T.error.message)}catch{D&&(E+=` ${D.slice(0,200)}`)}throw new Error(E)}const h=o,w=[];if(f.length>0){const D=f[0],E=f[f.length-1];w.push({createParagraphBullets:{range:{startIndex:h+D.start,endIndex:h+E.end},bulletPreset:"BULLET_DISC_CIRCLE_SQUARE"}})}if(u.length>0){const D=u[0],E=u[u.length-1];w.push({createParagraphBullets:{range:{startIndex:h+D.start,endIndex:h+E.end},bulletPreset:"NUMBERED_DECIMAL_ALPHA_ROMAN"}})}if(w.length>0){if(y=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:w})}),y.status===401)throw new Error("SESSION_EXPIRED");if(!y.ok){const D=await y.text();throw new Error(D?.slice(0,150)||"Docs API error")}}c.length;const A=h+1+_+d.length,j=A+l.length,V=[{updateTextStyle:{range:{startIndex:A,endIndex:j},textStyle:{link:{url:s||"#"}},fields:"link"}}];if(y=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:V})}),y.status===401)throw new Error("SESSION_EXPIRED");if(!y.ok){const D=await y.text();throw new Error(D?.slice(0,150)||"Docs API error")}}async function Pe(e,t,r){const{imageUrl:o,imageWidthPt:n,imageHeightPt:s,pageUrl:a,pageTitle:i,timestamp:l}=r,p=i||"Untitled",d=`
Source: `+p+" "+l,g=[{insertInlineImage:{uri:o,objectSize:{width:{magnitude:n,unit:"PT"},height:{magnitude:s,unit:"PT"}},endOfSegmentLocation:{segmentId:""}}},{insertText:{endOfSegmentLocation:{segmentId:""},text:d}}],c=`${L}/${e}:batchUpdate`;let f=await fetch(c,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:g})});if(f.status===401)throw new Error("SESSION_EXPIRED");if(!f.ok){const h=await f.text();let w=`Docs API error: ${f.status}`;try{const A=JSON.parse(h);A.error?.message&&(w=A.error.message)}catch{h&&(w+=` ${h.slice(0,200)}`)}throw new Error(w)}const u=await ee(e,t),_=d.length,S=u-_+9,m=S+p.length,y=[{updateTextStyle:{range:{startIndex:S,endIndex:m},textStyle:{link:{url:a||"#"}},fields:"link"}}];if(f=await fetch(c,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:y})}),f.status===401)throw new Error("SESSION_EXPIRED");if(!f.ok){const h=await f.text();let w=`Docs API error: ${f.status}`;try{const A=JSON.parse(h);A.error?.message&&(w=A.error.message)}catch{h&&(w+=` ${h.slice(0,200)}`)}throw new Error(w)}}const Oe="https://www.googleapis.com/drive/v3/files",Ce="application/vnd.google-apps.document";async function oe(e){const t=e||await Y(),r=`${Oe}?q=${encodeURIComponent(`mimeType='${Ce}'`)}&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc&pageSize=100`,o=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401){await W(t);const a=await H();if(a)return oe(a);throw new Error("Session expired. Please sign in again.")}if(!o.ok){const a=await o.text();let i=`Drive API error: ${o.status}`;try{const l=JSON.parse(a);l.error?.message&&(i=l.error.message)}catch{a&&(i+=` ${a.slice(0,200)}`)}throw new Error(i)}return((await o.json()).files||[]).map(a=>({id:a.id,name:a.name||"Untitled",modifiedTime:a.modifiedTime}))}const xe="https://www.googleapis.com/drive/v3/files";function Re(e){if(!e||typeof e!="string")return null;try{const t=new URL(e);if(t.hostname==="drive.google.com"&&t.pathname==="/uc")return t.searchParams.get("id");if(t.hostname==="drive.google.com"&&t.pathname.startsWith("/file/d/")){const r=t.pathname.match(/\/file\/d\/([^/]+)/);return r?r[1]:null}if(t.hostname==="www.googleapis.com"&&t.pathname.startsWith("/drive/v3/files/"))return t.pathname.replace(/^\/drive\/v3\/files\//,"").replace(/\?.*$/,"");if(t.hostname==="lh3.google.com"&&t.pathname.startsWith("/u/0/d/"))return t.pathname.replace(/^\/u\/0\/d\//,"").split("=")[0]}catch{}return null}async function Ue(e,t){const r=Re(e),o=r?`${xe}/${r}?alt=media`:e,n=await fetch(o,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error(`Image fetch: ${n.status}`);const s=await n.blob();if(!s.type||!s.type.startsWith("image/"))throw new Error("Not an image");return new Promise((a,i)=>{const l=new FileReader;l.onload=()=>a(l.result),l.onerror=()=>i(new Error("FileReader failed")),l.readAsDataURL(s)})}async function Le(e,t){const r=async o=>{if(o)try{return await Ue(o,t)}catch{return}};for(const o of e){if(o.type==="image"&&o.url){const n=await r(o.url);n&&(o.url=n)}if(o.type==="paragraph"&&Array.isArray(o.children)){for(const n of o.children)if(n.type==="image"&&n.url){const s=await r(n.url);s&&(n.url=s)}}}}const ke=Ie,ve=Ae,$e=Ne,Me=Pe,Ge=De,je=oe;function Be(e){const{selectedText:t="",pageTitle:r="Untitled",timestamp:o}=e,n=r||"Untitled";return`
`+t.trim()+`
Source: `+n+" "+(o||new Date().toISOString())}async function He(e,t,r){if(!e||!t||typeof r!="string")return!1;const o="https://docs.google.com/document/d/"+e+"/";let n;try{n=await chrome.tabs.query({url:o+"*"})}catch{return!1}const s=n&&n[0];if(!s?.id)return!1;try{await chrome.scripting.executeScript({target:{tabId:t},func:a=>typeof navigator.clipboard<"u"&&navigator.clipboard.writeText?navigator.clipboard.writeText(a):Promise.reject(new Error("Clipboard not available")),args:[r]})}catch{return!1}try{return await chrome.tabs.update(s.id,{active:!0}),await new Promise(i=>setTimeout(i,150)),(await chrome.tabs.sendMessage(s.id,{type:"TRIGGER_PASTE"}))?.ok===!0}catch{return!1}}async function ze(e,t,r,o){if(!e||!t||!r)return!1;const n="https://docs.google.com/document/d/"+e+"/";let s;try{s=await chrome.tabs.query({url:n+"*"})}catch{return!1}const a=s&&s[0];if(!a?.id)return!1;try{await chrome.scripting.executeScript({target:{tabId:t},func:async i=>{const p=await(await fetch(i)).blob();await navigator.clipboard.write([new ClipboardItem({"image/png":p})])},args:[r]})}catch{return!1}try{return await chrome.tabs.update(a.id,{active:!0}),await new Promise(i=>setTimeout(i,150)),await chrome.tabs.sendMessage(a.id,{type:"TRIGGER_PASTE"}),o&&(await chrome.scripting.executeScript({target:{tabId:t},func:i=>navigator.clipboard.writeText(i),args:[o]}),await new Promise(i=>setTimeout(i,80)),await chrome.tabs.sendMessage(a.id,{type:"TRIGGER_PASTE"})),!0}catch{return!1}}function qe(e){const t=e instanceof Error?e.message:String(e);return t.includes("Unable to download all specified images")||t.includes("download")?"Could not add text to the document. Try again in a moment.":t.includes("Session expired")||t.includes("Sign in required")?'Open the extension and click "Connect Google Docs" to sign in again.':t||"Something went wrong. Try again."}async function se(e,t){const r=await U();if(!r){I("No document selected","Open the EZ-NoteTaker extension and select a Google Doc to connect.");return}const o=Be(e);if(t&&await He(r,t,o)){I("Plugged in","Added at cursor in your open doc.");return}try{await C(n=>ve(r,n,e)),I("Plugged in","Highlight was added to your connected Google Doc.")}catch(n){if((n instanceof Error?n.message:String(n)).includes("Sign in required")){I("Sign in required",'Open the EZ-NoteTaker extension and click "Connect Google Docs" to sign in.');return}I("Could not plug in",qe(n))}}const ae="eznote-plug-it-in";function Je(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:ae,title:"Plug it in",contexts:["selection"]},()=>{chrome.runtime.lastError&&console.error("EZ-NoteTaker: context menu create failed",chrome.runtime.lastError)})})}async function Fe(e,t){if(!(e.menuItemId!==ae||!t?.id))try{const r=await B(t);if(!r.selectedText?.trim()){I("No text selected",'Select some text on the page, then right‑click and choose "Plug it in".');return}await se(r,t.id)}catch(r){console.error("EZ-NoteTaker: plug it in failed",r),I("Could not plug in",r instanceof Error?r.message:"Something went wrong. Try again.")}}async function Ve(e){if(e)try{const t=await chrome.tabs.get(e),r=await B(t);if(!r.selectedText?.trim()){I("No text selected",'Select some text on the page, then click "Plug it in" in the extension.');return}await se(r,t.id)}catch(t){console.error("EZ-NoteTaker: plug it in failed",t),I("Could not plug in",t instanceof Error?t.message:"Something went wrong. Try again.")}}const G="https://www.googleapis.com/drive/v3/files",Xe="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webContentLink,webViewLink",Ye="application/vnd.google-apps.folder",We="application/vnd.google-apps.document",Ze="Research Snips";async function Ke(e,t){const r=await fetch(`${G}/${e}/permissions`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({type:"anyone",role:"reader"})});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const o=await r.text();throw new Error(`Drive permission error: ${r.status} ${o.slice(0,150)}`)}}async function Qe(e){let t=await le();if(t)return t;const r=await fetch(G,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:Ze,mimeType:Ye})});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const n=await r.text();let s=`Drive create folder error: ${r.status}`;try{const a=JSON.parse(n);a.error?.message&&(s=a.error.message)}catch{}throw new Error(s)}if(t=(await r.json()).id,!t)throw new Error("No folder ID returned from Drive");return await ue(t),b.bg.info("Created Research Snips folder",t),t}async function et(e,t,r="eznote-snip.png",o=null){const n="-------"+Math.random().toString(36).slice(2,12),s={name:r,mimeType:t.type||"image/png"};o&&(s.parents=[o]);const a=[`\r
--`+n+`\r
`,`Content-Type: application/json; charset=UTF-8\r
\r
`,JSON.stringify(s)].join(""),i=[`\r
--`+n+`\r
`,"Content-Type: "+(t.type||"image/png")+`\r
\r
`].join(""),l=`\r
--`+n+`--\r
`,p=new Blob([a,i,t,l],{type:"multipart/related; boundary="+n}),d=await fetch(Xe,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/related; boundary="+n},body:p});if(d.status===401)throw new Error("SESSION_EXPIRED");if(!d.ok){const u=await d.text();let _=`Drive upload error: ${d.status}`;try{const S=JSON.parse(u);S.error?.message&&(_=S.error.message)}catch{u&&(_+=" "+u.slice(0,200))}throw new Error(_)}const g=await d.json(),c=g.id;if(!c)throw new Error("No file ID returned from Drive");await Ke(c,e);let f=g.webContentLink;if(!f){const u=await fetch(`${G}/${c}?fields=webContentLink`,{headers:{Authorization:`Bearer ${e}`}});u.ok&&(f=(await u.json()).webContentLink)}return f||(f=`https://drive.google.com/uc?export=view&id=${c}`),{fileId:c,imageUrl:f}}async function tt(e,t="Untitled"){const r=await fetch(G,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:t.trim()||"Untitled",mimeType:We})});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const s=await r.text();let a=`Drive create doc error: ${r.status}`;try{const i=JSON.parse(s);i.error?.message&&(a=i.error.message)}catch{}throw new Error(a)}const o=await r.json(),n=o.id;if(!n)throw new Error("No document ID returned from Drive");return{id:n,name:o.name||t||"Untitled"}}const nt="snipOverlay.js";async function x(e,t,r){I(t,r);try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}try{chrome.runtime.sendMessage({type:"SNIP_OVERLAY_CLOSED"})}catch{}}function rt(e){return typeof e!="string"?"Could not add image to document.":e.includes("Unable to download all specified images")?"Google Docs could not use the image link. Try again in a moment or use a smaller selection.":e}async function ot(e,t,r=null,o={}){const n=await U();if(!n){await x(e,"No document selected","Open EZ-NoteTaker and select a Google Doc to connect.");return}try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}await new Promise(h=>setTimeout(h,120));let s;try{s=await chrome.tabs.captureVisibleTab(r??void 0,{format:"png"})}catch(h){await x(e,"Capture failed",h?.message||"Could not capture the tab. Try again.");return}let a;try{a=await chrome.tabs.sendMessage(e,{type:"CROP_IMAGE",dataUrl:s,bounds:t})}catch{await x(e,"Snip failed","Could not process selection. Try again.");return}if(a?.type==="SNIP_ERROR"){await x(e,"Snip failed",a.error||"Crop failed.");return}if(a?.type!=="CROPPED_IMAGE"||!a.base64){await x(e,"Snip failed","No image data received.");return}const i=o.pageUrl??"",l=o.pageTitle??"Untitled",p=new Date().toISOString(),d=`
Source: `+l+" "+p;if(await ze(n,e,a.base64,d)){try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}I("Snip and Plug","Screenshot added at cursor in your open doc.");return}const c=await fetch(a.base64).then(h=>h.blob()),f=`eznote-snip-${Date.now()}.png`,u=a.width??400,_=a.height??300,S=72/96,m=Math.max(1,Math.round(u*S*.75)),y=Math.max(1,Math.round(_*S*.75));try{await C(async h=>{const w=await Qe(h),{imageUrl:A}=await et(h,c,f,w);await Me(n,h,{imageUrl:A,imageWidthPt:m,imageHeightPt:y,pageUrl:i,pageTitle:l,timestamp:p})}),I("Snip and Plug","Screenshot was added to your Google Doc.")}catch(h){const w=h instanceof Error?h.message:String(h);if(w.includes("Sign in required")){await x(e,"Sign in required",'Open EZ-NoteTaker and click "Connect Google Docs" to sign in.');return}await x(e,"Snip and Plug failed",rt(w))}}async function st(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:[nt]})}catch{I("Snip failed","Could not start snipping on this page. Try a different tab or reload.")}}async function at(e,t){const r=e?.type;if(r==="AUTH_GET_STATUS"){const o=await z(),n=await U(),s=await ie();return{sendResponse:!0,response:{connected:!!o,documentId:n||null,documentName:s||null}}}if(r==="AUTH_CONNECT")try{return await Ee({interactive:!0}),{sendResponse:!0,response:{success:!0}}}catch(o){return b.bg.warn("AUTH_CONNECT failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(r==="AUTH_DISCONNECT")return await we(),{sendResponse:!0,response:{success:!0}};if(r==="DOCS_LIST")try{return{sendResponse:!0,response:{success:!0,docs:await C(n=>je(n))}}}catch(o){return b.bg.warn("DOCS_LIST failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(r==="DOCS_SET_SELECTED"){const{documentId:o,documentName:n}=e;return o?(await X(o,n||""),{sendResponse:!0,response:{success:!0}}):{sendResponse:!0,response:{success:!1,error:"Missing documentId"}}}if(r==="DOCS_CREATE"){const o=typeof e.name=="string"?e.name.trim():"Untitled";try{const n=await C(s=>tt(s,o||"Untitled"));return await X(n.id,n.name),{sendResponse:!0,response:{success:!0,doc:{id:n.id,name:n.name}}}}catch(n){return b.bg.warn("DOCS_CREATE failed",n),{sendResponse:!0,response:{success:!1,error:n instanceof Error?n.message:String(n)}}}}if(r==="GET_PLUG_SELECTION"){const o=e.tabId;if(!o)return{sendResponse:!0,response:{success:!1,error:"No tab"}};try{const n=await chrome.tabs.get(o),s=await B(n);return{sendResponse:!0,response:{success:!0,selection:{selectedText:s.selectedText,pageUrl:s.pageUrl,pageTitle:s.pageTitle,timestamp:s.timestamp}}}}catch(n){return b.bg.warn("GET_PLUG_SELECTION failed",n),{sendResponse:!0,response:{success:!1,error:n instanceof Error?n.message:String(n)}}}}if(r==="DOCS_GET_SECTIONS")try{const o=await U();return o?{sendResponse:!0,response:{success:!0,sections:await C(s=>Ge(o,s))}}:{sendResponse:!0,response:{success:!1,error:"No document selected"}}}catch(o){return b.bg.warn("DOCS_GET_SECTIONS failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(r==="PLUG_IT_IN_AT_SECTION"){const{selectionData:o,insertIndex:n}=e;if(!o||typeof n!="number")return{sendResponse:!0,response:{success:!1,error:"Missing selectionData or insertIndex"}};try{const s=await U();return s?(await C(a=>$e(s,a,o,n)),{sendResponse:!0,response:{success:!0}}):{sendResponse:!0,response:{success:!1,error:"No document selected"}}}catch(s){return b.bg.warn("PLUG_IT_IN_AT_SECTION failed",s),{sendResponse:!0,response:{success:!1,error:s instanceof Error?s.message:String(s)}}}}return r==="GET_DOC_PREVIEW"?((async()=>{let o;try{const n=await U();if(!n)o={error:"No document selected"};else{const s=await C(async a=>{const i=await ke(n,a);return await Le(i.blocks,a),i});o={title:s.title,blocks:s.blocks}}}catch(n){o={error:n instanceof Error?n.message:"Failed to load preview"}}try{chrome.runtime.sendMessage({type:"DOC_PREVIEW_RESULT",...o})}catch{}})(),{sendResponse:!1}):null}const J="eznote_snip_overlay_active",F="eznote_snip_tab_id",k=chrome.storage?.session||chrome.storage?.local;function v(e,t=null){return k?k.set({[J]:!!e,[F]:e&&t!=null?t:null}):Promise.resolve()}function it(){return k?k.get(J).then(e=>!!e[J]):Promise.resolve(!1)}chrome.runtime.onInstalled.addListener(()=>{Je()}),chrome.action.onClicked.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e?.[0];t?.windowId&&chrome.sidePanel.open({windowId:t.windowId}).catch(r=>b.bg.error("open side panel failed",r))})}),chrome.tabs.onUpdated.addListener((e,t)=>{t.status==="loading"&&k?.get(F).then(r=>{r[F]===e&&v(!1)})}),chrome.contextMenus.onClicked.addListener((e,t)=>{Fe(e,t).catch(r=>b.bg.error("plug it in failed",r))}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(["AUTH_GET_STATUS","AUTH_CONNECT","AUTH_DISCONNECT","DOCS_LIST","DOCS_SET_SELECTED","DOCS_CREATE","DOCS_GET_SECTIONS","GET_PLUG_SELECTION","PLUG_IT_IN_AT_SECTION","GET_DOC_PREVIEW"].includes(e?.type))return at(e).then(n=>{n&&n.sendResponse&&r(n.response)}).catch(n=>{b.bg.error("messageHub",n),r({error:n instanceof Error?n.message:String(n)})}),!0;if(e.type==="START_SNIP"){const n=e.tabId??t.tab?.id;return n?st(n).then(()=>r({ok:!0}),s=>r({error:String(s)})):r({error:"No tab"}),!0}if(e.type==="SNIP_OVERLAY_CREATED"){const n=t.tab?.id;return n&&v(!0,n),!1}if(e.type==="SNIP_BOUNDS"){v(!1);const n=t.tab?.id,s=t.tab?.windowId??null;return n&&e.bounds?ot(n,e.bounds,s,{pageUrl:e.pageUrl,pageTitle:e.pageTitle}).then(()=>r({ok:!0}),a=>r({error:String(a)})):r({error:"No tab or bounds"}),!0}if(e.type==="SNIP_CANCEL")return v(!1),r({ok:!0}),!0;if(e.type==="PLUG_IT_IN"){const n=e.tabId??t.tab?.id;return n?Ve(n).then(()=>r({ok:!0}),s=>r({error:String(s)})):r({error:"No tab"}),!0}return e.type==="GET_SNIP_STATE"?(it().then(n=>r({active:n})),!0):(e.type==="SNIP_OVERLAY_CLOSED"&&v(!1),!1)})})();
