(function(){"use strict";async function q(e){const t=new Date().toISOString(),r=e.url||"",o=e.title||"Untitled",n={target:{tabId:e.id},func:()=>window.getSelection()?.toString()?.trim()??""},[s]=await chrome.scripting.executeScript(n);return{selectedText:s?.result??"",pageUrl:r,pageTitle:o,timestamp:t}}const D={SELECTED_DOCUMENT_ID:"eznote_selected_document_id",SELECTED_DOCUMENT_NAME:"eznote_selected_document_name",RESEARCH_SNIPS_FOLDER_ID:"eznote_research_snips_folder_id"};function L(){return typeof chrome>"u"||!chrome.storage?.local?null:chrome.storage.local}function k(){const e=L();return e?e.get(D.SELECTED_DOCUMENT_ID).then(t=>t[D.SELECTED_DOCUMENT_ID]||null):Promise.resolve(null)}function le(){const e=L();return e?e.get(D.SELECTED_DOCUMENT_NAME).then(t=>t[D.SELECTED_DOCUMENT_NAME]||null):Promise.resolve(null)}function Y(e,t=""){const r=L();return r?r.set({[D.SELECTED_DOCUMENT_ID]:e,[D.SELECTED_DOCUMENT_NAME]:t||""}):Promise.resolve()}function ue(){const e=L();return e?e.remove([D.SELECTED_DOCUMENT_ID,D.SELECTED_DOCUMENT_NAME]):Promise.resolve()}function de(){const e=L();return e?e.get(D.RESEARCH_SNIPS_FOLDER_ID).then(t=>t[D.RESEARCH_SNIPS_FOLDER_ID]||null):Promise.resolve(null)}function he(e){const t=L();return t?t.set({[D.RESEARCH_SNIPS_FOLDER_ID]:e}):Promise.resolve()}const N=typeof chrome<"u"&&chrome.identity,j="eznote_access_token";function Z(){return!N||!N.getAuthToken?Promise.reject(new Error("Chrome identity API is not available.")):new Promise((e,t)=>{N.getAuthToken({interactive:!0},r=>{if(chrome.runtime.lastError){const o=chrome.runtime.lastError.message||"Failed to get auth token";t(new Q(o,chrome.runtime.lastError));return}if(!r){t(new Q("No token returned."));return}e(r)})})}function fe(){return!N||!N.getAuthToken?Promise.resolve(null):new Promise(e=>{N.getAuthToken({interactive:!1},t=>{if(chrome.runtime.lastError||!t){e(null);return}e(t)})})}function ge(e){return!N||!N.removeCachedAuthToken?Promise.resolve():new Promise(t=>{N.removeCachedAuthToken({token:e},()=>{t()})})}function me(){return!N||!N.clearAllCachedAuthTokens?Promise.resolve():N.clearAllCachedAuthTokens()}function K(e){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.set({[j]:e})}function pe(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve(null):chrome.storage.local.get(j).then(e=>e[j]||null)}function Ee(){return typeof chrome>"u"||!chrome.storage?.local?Promise.resolve():chrome.storage.local.remove(j)}class Q extends Error{constructor(t,r){super(t),this.name="AuthError",this.chromeError=r}get isUserCancel(){const t=(this.message||"").toLowerCase();return t.includes("cancel")||t.includes("access_denied")||t.includes("user did not approve")}}const B=()=>{};function we(e){const t=`[EZ-Note ${e}]`;return{debug:typeof console<"u"&&console.debug?(...r)=>console.debug(t,...r):B,info:typeof console<"u"&&console.info?(...r)=>console.info(t,...r):B,warn:typeof console<"u"&&console.warn?(...r)=>console.warn(t,...r):B,error:typeof console<"u"&&console.error?(...r)=>console.error(t,...r):B}}const A={bg:we("BG")},Se="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKklEQVQ4T2NkYGD4z0ABYBzVMGoB1AIMDAwM/xkZGP4zMjL+Z2RkZPwPAG2cBAdMLsCFAAAAAElFTkSuQmCC";function b(e,t){typeof chrome>"u"||!chrome.notifications?.create||chrome.notifications.create({type:"basic",iconUrl:Se,title:e,message:t})}const ye="SESSION_EXPIRED";function Te(e){const t=e instanceof Error?e.message:String(e);return t===ye||t.includes("401")||t.includes("UNAUTHENTICATED")||t.includes("invalid authentication")||t.includes("Invalid Credentials")||t.includes("Session expired")}async function J(){return pe()}async function Ie(e){const t=chrome?.identity;if(!t?.getRedirectURL||!t?.launchWebAuthFlow)throw new Error("Chrome identity API is not available.");const r=chrome.runtime.getManifest(),o=Array.isArray(r?.oauth2?.scopes)?r.oauth2.scopes:[];if(o.length===0)throw new Error("OAuth2 scopes missing in manifest.");const n=e&&e.trim()||r?.oauth2?.client_id;if(!n)throw new Error("Set VITE_GOOGLE_DOCS_WEB_CLIENT_ID in .env to your Web application OAuth client ID (with redirect URI "+t.getRedirectURL()+").");const s=t.getRedirectURL("oauth2"),i=o.join(" "),d=`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:n,redirect_uri:s,response_type:"token",scope:i,prompt:"select_account"}).toString()}`;return new Promise((w,u)=>{t.launchWebAuthFlow({url:d,interactive:!0},h=>{if(chrome.runtime?.lastError){const m=chrome.runtime.lastError.message||"";if(m.toLowerCase().includes("cancel")||m.includes("access_denied")){u(new Error("Sign-in was cancelled."));return}u(new Error(chrome.runtime.lastError.message||"Sign-in failed."));return}if(!h){u(new Error("No callback URL received."));return}const f=new URL(h).hash?.slice(1)||"",l=new URLSearchParams(f),c=l.get("access_token");if(!c){const m=l.get("error_description")||l.get("error")||"Missing access token";u(new Error(m));return}K(c).then(()=>w(c))})})}async function _e(e={interactive:!1}){if(e.interactive){const r=e.webClientId||"";if(r.trim())try{return await Ie(r.trim())}catch(n){A.bg.warn("launchWebAuthFlow failed, falling back to getAuthToken",n?.message)}const o=await Z();return await K(o),o}const t=await J();if(!t)throw new Error("Not signed in");return t}async function R(e){const t=await J();if(!t)throw A.bg.warn("withTokenRetry: no token"),new Error("Sign in required");try{return await e(t)}catch(r){throw Te(r)?(A.bg.info("Auth error, clearing state"),await F(),b("Session expired","Please open the extension and connect Google Docs again."),new Error("Session expired")):r}}async function F(){await Ee();try{await me()}catch{}await ue(),A.bg.info("Auth state cleared")}async function Ae(){await F()}const be="https://docs.googleapis.com/v1/documents",Pe={HEADING_1:"heading1",HEADING_2:"heading2",HEADING_3:"heading3",HEADING_4:"heading4",HEADING_5:"heading5",HEADING_6:"heading6",NORMAL_TEXT:"normal",TITLE:"title",SUBTITLE:"subtitle"};function Ne(e,t){if(!e||!t)return null;const r=e[t],o=r?.inlineObjectProperties?.embeddedObject?.imageProperties?.sourceUri||r?.inlineObjectProperties?.embeddedObject?.imageProperties?.contentUri;return typeof o=="string"&&o.length>0?o:null}function De(e,t){if(!Array.isArray(e))return[];const r=[];for(const o of e){const n=o.paragraph;if(!n)continue;const s=n.paragraphStyle?.namedStyleType,i=Pe[s]??"normal",a=!!n.bullet,d=[];if(Array.isArray(n.elements))for(const u of n.elements){if(u.textRun?.content!==void 0){const h=u.textRun.content,f=u.textRun.textStyle||{};d.push({type:"text",value:h,bold:f.bold===!0,italic:f.italic===!0,underline:f.underline===!0,strikethrough:f.strikethrough===!0})}if(u.inlineObjectElement?.inlineObjectId){const h=Ne(t,u.inlineObjectElement.inlineObjectId);h&&d.push({type:"image",url:h})}}(d.some(u=>u.type==="image"||u.type==="text"&&u.value.trim()!=="")||a)&&r.push({type:"paragraph",style:i,listItem:a,children:d})}return r}async function Oe(e,t){const r=["title","body.content(paragraph(elements(textRun(content,textStyle(bold,italic,underline,strikethrough)),inlineObjectElement(inlineObjectId)),paragraphStyle(namedStyleType),bullet))","inlineObjects"].join(","),o=`${be}/${e}?fields=${encodeURIComponent(r)}`,n=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const u=await n.text();let h=`Docs API error: ${n.status}`;try{const f=JSON.parse(u);f.error?.message&&(h=f.error.message)}catch{u&&(h+=` ${u.slice(0,200)}`)}throw new Error(h)}const s=await n.json(),i=s.title??"Untitled",a=s.body?.content??[],d=s.inlineObjects??{},w=De(a,d);return{title:i,blocks:w}}const v="https://docs.googleapis.com/v1/documents";async function ee(e,t){const r=`${v}/${e}?fields=body.content(endIndex)`,o=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401)throw new Error("SESSION_EXPIRED");if(!o.ok){const i=await o.text();let a=`Docs API error: ${o.status}`;try{const d=JSON.parse(i);d.error?.message&&(a=d.error.message)}catch{i&&(a+=` ${i.slice(0,200)}`)}throw new Error(a)}const s=(await o.json()).body?.content||[];return s.length===0?0:Math.max(...s.map(i=>i.endIndex||0))}const te=/^[\s\t]*([•·▪◦\-*]\s+)/,ne=/^[\s\t]*(\d+[.)]\s+)/;function re(e,t,r,o){const n=e.split(/\n/),s=[],i=[],a=[];let d=1;for(const h of n){const f=h.match(te),l=!f&&h.match(ne);let c=h,m=h.length+1;f?(c=h.replace(te,"").trimStart(),c=c||" ",m=c.length+1,i.push({start:d,end:d+c.length+1})):l?(c=h.replace(ne,"").trimStart(),c=c||" ",m=c.length+1,a.push({start:d,end:d+c.length+1})):c=c||" ",s.push(c),d+=m}const w=s.join(`
`);return{textToInsert:`
`+w+t+r+o,bulletRanges:i,numberedRanges:a,quoteLen:w.length}}async function Ce(e,t,r){const{selectedText:o,pageUrl:n,pageTitle:s,timestamp:i}=r,a=s||"Untitled",d=o||"",w=`
Source: `,u=` ${i}`,{textToInsert:h,bulletRanges:f,numberedRanges:l,quoteLen:c}=re(d,w,a,u),m=[{insertText:{endOfSegmentLocation:{segmentId:""},text:h}}],I=`${v}/${e}:batchUpdate`;let y=await fetch(I,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:m})});if(y.status===401)throw new Error("SESSION_EXPIRED");if(!y.ok){const T=await y.text();let _=`Docs API error: ${y.status}`;try{const O=JSON.parse(T);O.error?.message&&(_=O.error.message)}catch{T&&(_+=` ${T.slice(0,200)}`)}throw new Error(_)}const S=await ee(e,t),g=S-h.length,p=[];if(f.length>0){const T=f[0],_=f[f.length-1];p.push({createParagraphBullets:{range:{startIndex:g+T.start,endIndex:g+_.end},bulletPreset:"BULLET_DISC_CIRCLE_SQUARE"}})}if(l.length>0){const T=l[0],_=l[l.length-1];p.push({createParagraphBullets:{range:{startIndex:g+T.start,endIndex:g+_.end},bulletPreset:"NUMBERED_DECIMAL_ALPHA_ROMAN"}})}if(p.length>0){if(y=await fetch(I,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:p})}),y.status===401)throw new Error("SESSION_EXPIRED");if(!y.ok){const T=await y.text();let _=`Docs API error: ${y.status}`;try{const O=JSON.parse(T);O.error?.message&&(_=O.error.message)}catch{T&&(_+=` ${T.slice(0,200)}`)}throw new Error(_)}}const E=h.length,x=S-E+1+c+w.length,$=x+a.length,P=[{updateTextStyle:{range:{startIndex:x,endIndex:$},textStyle:{link:{url:n||"#"}},fields:"link"}}];if(y=await fetch(I,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:P})}),y.status===401)throw new Error("SESSION_EXPIRED");if(!y.ok){const T=await y.text();let _=`Docs API error: ${y.status}`;try{const O=JSON.parse(T);O.error?.message&&(_=O.error.message)}catch{T&&(_+=` ${T.slice(0,200)}`)}throw new Error(_)}}const xe=new Set(["HEADING_1","HEADING_2","HEADING_3","HEADING_4","HEADING_5","HEADING_6","TITLE","SUBTITLE"]);async function Re(e,t){const r=["body.content(startIndex,endIndex,paragraph(paragraphStyle(namedStyleType),elements(textRun(content))))"].join(","),o=`${v}/${e}?fields=${encodeURIComponent(r)}`,n=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(n.status===401)throw new Error("SESSION_EXPIRED");if(!n.ok){const l=await n.text();let c=`Docs API error: ${n.status}`;try{const m=JSON.parse(l);m.error?.message&&(c=m.error.message)}catch{l&&(c+=` ${l.slice(0,200)}`)}throw new Error(c)}const i=(await n.json()).body?.content||[];let a=1,d=1;const w=[],u=[];for(const l of i){const c=l.endIndex??l.startIndex??0;c>a&&(a=c);const m=l.paragraph,I=m?.paragraphStyle?.namedStyleType,y=m&&xe.has(I),S=I==="TITLE"||I==="SUBTITLE";if(y){if(w.length>0){const g=Math.max(1,d-1);u[u.length-1]=g}if(!S){let g="";if(Array.isArray(m.elements))for(const p of m.elements)p.textRun?.content&&(g+=p.textRun.content);g=g.replace(/\n/g," ").trim().slice(0,60)||"(unnamed)",w.push(g),u.push(null)}}else d=c}u.length>0&&(u[u.length-1]=Math.max(1,d-1));const h=Math.max(1,a-1),f=[{label:"At the beginning",index:1}];for(let l=0;l<w.length;l++){const c=u[l]!=null?u[l]:h;f.push({label:"End of section: "+w[l],index:c})}return f.push({label:"At the end",index:h}),f}async function Ue(e,t,r,o){const{selectedText:n,pageUrl:s,pageTitle:i,timestamp:a}=r,d=i||"Untitled",w=n||"",u=`
Source: `,h=` ${a}`,{textToInsert:f,bulletRanges:l,numberedRanges:c,quoteLen:m}=re(w,u,d,h),I=[{insertText:{location:{index:o},text:f}}],y=`${v}/${e}:batchUpdate`;let S=await fetch(y,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:I})});if(S.status===401)throw new Error("SESSION_EXPIRED");if(!S.ok){const P=await S.text();let T=`Docs API error: ${S.status}`;try{const _=JSON.parse(P);_.error?.message&&(T=_.error.message)}catch{P&&(T+=` ${P.slice(0,200)}`)}throw new Error(T)}const g=o,p=[];if(l.length>0){const P=l[0],T=l[l.length-1];p.push({createParagraphBullets:{range:{startIndex:g+P.start,endIndex:g+T.end},bulletPreset:"BULLET_DISC_CIRCLE_SQUARE"}})}if(c.length>0){const P=c[0],T=c[c.length-1];p.push({createParagraphBullets:{range:{startIndex:g+P.start,endIndex:g+T.end},bulletPreset:"NUMBERED_DECIMAL_ALPHA_ROMAN"}})}if(p.length>0){if(S=await fetch(y,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:p})}),S.status===401)throw new Error("SESSION_EXPIRED");if(!S.ok){const P=await S.text();throw new Error(P?.slice(0,150)||"Docs API error")}}f.length;const E=g+1+m+u.length,x=E+d.length,$=[{updateTextStyle:{range:{startIndex:E,endIndex:x},textStyle:{link:{url:s||"#"}},fields:"link"}}];if(S=await fetch(y,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:$})}),S.status===401)throw new Error("SESSION_EXPIRED");if(!S.ok){const P=await S.text();throw new Error(P?.slice(0,150)||"Docs API error")}}async function Le(e,t,r){const{imageUrl:o,imageWidthPt:n,imageHeightPt:s,pageUrl:i,pageTitle:a,timestamp:d}=r,w=a||"Untitled",u=`
Source: `+w+" "+d,h=[{insertInlineImage:{uri:o,objectSize:{width:{magnitude:n,unit:"PT"},height:{magnitude:s,unit:"PT"}},endOfSegmentLocation:{segmentId:""}}},{insertText:{endOfSegmentLocation:{segmentId:""},text:u}}],f=`${v}/${e}:batchUpdate`;let l=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:h})});if(l.status===401)throw new Error("SESSION_EXPIRED");if(!l.ok){const g=await l.text();let p=`Docs API error: ${l.status}`;try{const E=JSON.parse(g);E.error?.message&&(p=E.error.message)}catch{g&&(p+=` ${g.slice(0,200)}`)}throw new Error(p)}const c=await ee(e,t),m=u.length,I=c-m+9,y=I+w.length,S=[{updateTextStyle:{range:{startIndex:I,endIndex:y},textStyle:{link:{url:i||"#"}},fields:"link"}}];if(l=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:S})}),l.status===401)throw new Error("SESSION_EXPIRED");if(!l.ok){const g=await l.text();let p=`Docs API error: ${l.status}`;try{const E=JSON.parse(g);E.error?.message&&(p=E.error.message)}catch{g&&(p+=` ${g.slice(0,200)}`)}throw new Error(p)}}async function ke(e,t,r,o){const{imageUrl:n,imageWidthPt:s,imageHeightPt:i,pageUrl:a,pageTitle:d,timestamp:w}=r,u=d||"Untitled",h=`
Source: `+u+" "+w,f=[{insertInlineImage:{uri:n,objectSize:{width:{magnitude:s,unit:"PT"},height:{magnitude:i,unit:"PT"}},location:{index:o}}},{insertText:{location:{index:o+1},text:h}}],l=`${v}/${e}:batchUpdate`;let c=await fetch(l,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:f})});if(c.status===401)throw new Error("SESSION_EXPIRED");if(!c.ok){const S=await c.text();let g=`Docs API error: ${c.status}`;try{const p=JSON.parse(S);p.error?.message&&(g=p.error.message)}catch{S&&(g+=` ${S.slice(0,200)}`)}throw new Error(g)}const m=o+1+9,I=m+u.length,y=[{updateTextStyle:{range:{startIndex:m,endIndex:I},textStyle:{link:{url:a||"#"}},fields:"link"}}];if(c=await fetch(l,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({requests:y})}),c.status===401)throw new Error("SESSION_EXPIRED");if(!c.ok){const S=await c.text();let g=`Docs API error: ${c.status}`;try{const p=JSON.parse(S);p.error?.message&&(g=p.error.message)}catch{S&&(g+=` ${S.slice(0,200)}`)}throw new Error(g)}}const ve="https://www.googleapis.com/drive/v3/files",$e="application/vnd.google-apps.document";async function oe(e){const t=e||await Z(),r=`${ve}?q=${encodeURIComponent(`mimeType='${$e}'`)}&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc&pageSize=100`,o=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(o.status===401){await ge(t);const i=await fe();if(i)return oe(i);throw new Error("Session expired. Please sign in again.")}if(!o.ok){const i=await o.text();let a=`Drive API error: ${o.status}`;try{const d=JSON.parse(i);d.error?.message&&(a=d.error.message)}catch{i&&(a+=` ${i.slice(0,200)}`)}throw new Error(a)}return((await o.json()).files||[]).map(i=>({id:i.id,name:i.name||"Untitled",modifiedTime:i.modifiedTime}))}const Me="https://www.googleapis.com/drive/v3/files";function Ge(e){if(!e||typeof e!="string")return null;try{const t=new URL(e);if(t.hostname==="drive.google.com"&&t.pathname==="/uc")return t.searchParams.get("id");if(t.hostname==="drive.google.com"&&t.pathname.startsWith("/file/d/")){const r=t.pathname.match(/\/file\/d\/([^/]+)/);return r?r[1]:null}if(t.hostname==="www.googleapis.com"&&t.pathname.startsWith("/drive/v3/files/"))return t.pathname.replace(/^\/drive\/v3\/files\//,"").replace(/\?.*$/,"");if(t.hostname==="lh3.google.com"&&t.pathname.startsWith("/u/0/d/"))return t.pathname.replace(/^\/u\/0\/d\//,"").split("=")[0]}catch{}return null}async function je(e,t){const r=Ge(e),o=r?`${Me}/${r}?alt=media`:e,n=await fetch(o,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error(`Image fetch: ${n.status}`);const s=await n.blob();if(!s.type||!s.type.startsWith("image/"))throw new Error("Not an image");return new Promise((i,a)=>{const d=new FileReader;d.onload=()=>i(d.result),d.onerror=()=>a(new Error("FileReader failed")),d.readAsDataURL(s)})}async function Be(e,t){const r=async o=>{if(o)try{return await je(o,t)}catch{return}};for(const o of e){if(o.type==="image"&&o.url){const n=await r(o.url);n&&(o.url=n)}if(o.type==="paragraph"&&Array.isArray(o.children)){for(const n of o.children)if(n.type==="image"&&n.url){const s=await r(n.url);s&&(n.url=s)}}}}const He=Oe,ze=Ce,qe=Ue,Je=Le,Fe=ke,Ve=Re,We=oe;function Xe(e){const{selectedText:t="",pageTitle:r="Untitled",timestamp:o}=e,n=r||"Untitled";return`
`+t.trim()+`
Source: `+n+" "+(o||new Date().toISOString())}async function Ye(e,t,r){if(!e||!t||typeof r!="string")return!1;const o="https://docs.google.com/document/d/"+e+"/";let n;try{n=await chrome.tabs.query({url:o+"*"})}catch{return!1}const s=n&&n[0];if(!s?.id)return!1;try{await chrome.scripting.executeScript({target:{tabId:t},func:i=>typeof navigator.clipboard<"u"&&navigator.clipboard.writeText?navigator.clipboard.writeText(i):Promise.reject(new Error("Clipboard not available")),args:[r]})}catch{return!1}try{return await chrome.tabs.update(s.id,{active:!0}),await new Promise(a=>setTimeout(a,150)),(await chrome.tabs.sendMessage(s.id,{type:"TRIGGER_PASTE"}))?.ok===!0}catch{return!1}}async function Ze(e,t,r,o){if(!e||!t||!r)return!1;const n="https://docs.google.com/document/d/"+e+"/";let s;try{s=await chrome.tabs.query({url:n+"*"})}catch{return!1}const i=s&&s[0];if(!i?.id)return!1;try{await chrome.scripting.executeScript({target:{tabId:t},func:async a=>{const w=await(await fetch(a)).blob();await navigator.clipboard.write([new ClipboardItem({"image/png":w})])},args:[r]})}catch{return!1}try{return await chrome.tabs.update(i.id,{active:!0}),await new Promise(a=>setTimeout(a,150)),await chrome.tabs.sendMessage(i.id,{type:"TRIGGER_PASTE"}),o&&(await chrome.scripting.executeScript({target:{tabId:t},func:a=>navigator.clipboard.writeText(a),args:[o]}),await new Promise(a=>setTimeout(a,80)),await chrome.tabs.sendMessage(i.id,{type:"TRIGGER_PASTE"})),!0}catch{return!1}}function Ke(e){const t=e instanceof Error?e.message:String(e);return t.includes("Unable to download all specified images")||t.includes("download")?"Could not add text to the document. Try again in a moment.":t.includes("Session expired")||t.includes("Sign in required")?'Open the extension and click "Connect Google Docs" to sign in again.':t||"Something went wrong. Try again."}async function se(e,t){const r=await k();if(!r){b("No document selected","Open the EZ-NoteTaker extension and select a Google Doc to connect.");return}const o=Xe(e);if(t&&await Ye(r,t,o)){b("Plugged in","Added at cursor in your open doc.");return}try{await R(n=>ze(r,n,e)),b("Plugged in","Highlight was added to your connected Google Doc.")}catch(n){if((n instanceof Error?n.message:String(n)).includes("Sign in required")){b("Sign in required",'Open the EZ-NoteTaker extension and click "Connect Google Docs" to sign in.');return}b("Could not plug in",Ke(n))}}const ie="eznote-plug-it-in";function Qe(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:ie,title:"Plug it in",contexts:["selection"]},()=>{chrome.runtime.lastError&&console.error("EZ-NoteTaker: context menu create failed",chrome.runtime.lastError)})})}async function et(e,t){if(!(e.menuItemId!==ie||!t?.id))try{const r=await q(t);if(!r.selectedText?.trim()){b("No text selected",'Select some text on the page, then right‑click and choose "Plug it in".');return}await se(r,t.id)}catch(r){console.error("EZ-NoteTaker: plug it in failed",r),b("Could not plug in",r instanceof Error?r.message:"Something went wrong. Try again.")}}async function tt(e){if(e)try{const t=await chrome.tabs.get(e),r=await q(t);if(!r.selectedText?.trim()){b("No text selected",'Select some text on the page, then click "Plug it in" in the extension.');return}await se(r,t.id)}catch(t){console.error("EZ-NoteTaker: plug it in failed",t),b("Could not plug in",t instanceof Error?t.message:"Something went wrong. Try again.")}}const H="https://www.googleapis.com/drive/v3/files",nt="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webContentLink,webViewLink",rt="application/vnd.google-apps.folder",ot="application/vnd.google-apps.document",st="Research Snips";async function it(e,t){const r=await fetch(`${H}/${e}/permissions`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({type:"anyone",role:"reader"})});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const o=await r.text();throw new Error(`Drive permission error: ${r.status} ${o.slice(0,150)}`)}}async function at(e){let t=await de();if(t)return t;const r=await fetch(H,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:st,mimeType:rt})});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const n=await r.text();let s=`Drive create folder error: ${r.status}`;try{const i=JSON.parse(n);i.error?.message&&(s=i.error.message)}catch{}throw new Error(s)}if(t=(await r.json()).id,!t)throw new Error("No folder ID returned from Drive");return await he(t),A.bg.info("Created Research Snips folder",t),t}async function ct(e,t,r="eznote-snip.png",o=null){const n="-------"+Math.random().toString(36).slice(2,12),s={name:r,mimeType:t.type||"image/png"};o&&(s.parents=[o]);const i=[`\r
--`+n+`\r
`,`Content-Type: application/json; charset=UTF-8\r
\r
`,JSON.stringify(s)].join(""),a=[`\r
--`+n+`\r
`,"Content-Type: "+(t.type||"image/png")+`\r
\r
`].join(""),d=`\r
--`+n+`--\r
`,w=new Blob([i,a,t,d],{type:"multipart/related; boundary="+n}),u=await fetch(nt,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"multipart/related; boundary="+n},body:w});if(u.status===401)throw new Error("SESSION_EXPIRED");if(!u.ok){const c=await u.text();let m=`Drive upload error: ${u.status}`;try{const I=JSON.parse(c);I.error?.message&&(m=I.error.message)}catch{c&&(m+=" "+c.slice(0,200))}throw new Error(m)}const h=await u.json(),f=h.id;if(!f)throw new Error("No file ID returned from Drive");await it(f,e);let l=h.webContentLink;if(!l){const c=await fetch(`${H}/${f}?fields=webContentLink`,{headers:{Authorization:`Bearer ${e}`}});c.ok&&(l=(await c.json()).webContentLink)}return l||(l=`https://drive.google.com/uc?export=view&id=${f}`),{fileId:f,imageUrl:l}}async function lt(e,t="Untitled"){const r=await fetch(H,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({name:t.trim()||"Untitled",mimeType:ot})});if(r.status===401)throw new Error("SESSION_EXPIRED");if(!r.ok){const s=await r.text();let i=`Drive create doc error: ${r.status}`;try{const a=JSON.parse(s);a.error?.message&&(i=a.error.message)}catch{}throw new Error(i)}const o=await r.json(),n=o.id;if(!n)throw new Error("No document ID returned from Drive");return{id:n,name:o.name||t||"Untitled"}}const ut="snipOverlay.js",z="eznote_snip_insert_index",ae="eznote_snip_insert_success",C=chrome.storage?.session||chrome.storage?.local;async function dt(){if(!C)return null;const t=(await C.get(z))[z];return typeof t=="number"?t:null}function ht(e){return C?C.set({[z]:e}):Promise.resolve()}function V(){return C?C.remove(z):Promise.resolve()}async function U(e,t,r){b(t,r);try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}try{chrome.runtime.sendMessage({type:"SNIP_OVERLAY_CLOSED"})}catch{}}function ft(e){return typeof e!="string"?"Could not add image to document.":e.includes("Unable to download all specified images")?"Google Docs could not use the image link. Try again in a moment or use a smaller selection.":e}async function gt(e,t,r=null,o={}){const n=await k();if(!n){await U(e,"No document selected","Open EZ-NoteTaker and select a Google Doc to connect.");return}try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}await new Promise(E=>setTimeout(E,120));let s;try{s=await chrome.tabs.captureVisibleTab(r??void 0,{format:"png"})}catch(E){await U(e,"Capture failed",E?.message||"Could not capture the tab. Try again.");return}let i;try{i=await chrome.tabs.sendMessage(e,{type:"CROP_IMAGE",dataUrl:s,bounds:t})}catch{await U(e,"Snip failed","Could not process selection. Try again.");return}if(i?.type==="SNIP_ERROR"){await U(e,"Snip failed",i.error||"Crop failed.");return}if(i?.type!=="CROPPED_IMAGE"||!i.base64){await U(e,"Snip failed","No image data received.");return}const a=o.pageUrl??"",d=o.pageTitle??"Untitled",w=new Date().toISOString(),u=`
Source: `+d+" "+w,h=await dt();if(await V(),!h&&await Ze(n,e,i.base64,u)){try{await chrome.tabs.sendMessage(e,{type:"REMOVE_SNIP_OVERLAY"})}catch{}C&&await C.set({[ae]:!0}),b("Snip and Plug","Screenshot added at cursor in your open doc.");return}const l=await fetch(i.base64).then(E=>E.blob()),c=`eznote-snip-${Date.now()}.png`,m=i.width??400,I=i.height??300,y=72/96,S=Math.max(1,Math.round(m*y*.75)),g=Math.max(1,Math.round(I*y*.75)),p={imageWidthPt:S,imageHeightPt:g,pageUrl:a,pageTitle:d,timestamp:w};try{await R(async E=>{const x=await at(E),{imageUrl:$}=await ct(E,l,c,x);typeof h=="number"?await Fe(n,E,{...p,imageUrl:$},h):await Je(n,E,{...p,imageUrl:$})}),C&&await C.set({[ae]:!0}),b("Snip and Plug","Screenshot was added to your Google Doc.")}catch(E){const x=E instanceof Error?E.message:String(E);if(x.includes("Sign in required")){await U(e,"Sign in required",'Open EZ-NoteTaker and click "Connect Google Docs" to sign in.');return}await U(e,"Snip and Plug failed",ft(x))}}async function ce(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:[ut]})}catch{b("Snip failed","Could not start snipping on this page. Try a different tab or reload.")}}async function mt(e,t){const r=e?.type;if(r==="AUTH_GET_STATUS"){const o=await J(),n=await k(),s=await le();return{sendResponse:!0,response:{connected:!!o,documentId:n||null,documentName:s||null}}}if(r==="AUTH_CONNECT"){const o=typeof chrome?.identity?.getRedirectURL=="function"?chrome.identity.getRedirectURL("oauth2"):"";try{await F();const n=e.webClientId||"";return await _e({interactive:!0,webClientId:n}),{sendResponse:!0,response:{success:!0}}}catch(n){return A.bg.warn("AUTH_CONNECT failed",n),{sendResponse:!0,response:{success:!1,error:n instanceof Error?n.message:String(n),redirectUri:o}}}}if(r==="AUTH_DISCONNECT")return await Ae(),{sendResponse:!0,response:{success:!0}};if(r==="DOCS_LIST")try{return{sendResponse:!0,response:{success:!0,docs:await R(n=>We(n))}}}catch(o){return A.bg.warn("DOCS_LIST failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(r==="DOCS_SET_SELECTED"){const{documentId:o,documentName:n}=e;return o?(await Y(o,n||""),{sendResponse:!0,response:{success:!0}}):{sendResponse:!0,response:{success:!1,error:"Missing documentId"}}}if(r==="DOCS_CREATE"){const o=typeof e.name=="string"?e.name.trim():"Untitled";try{const n=await R(s=>lt(s,o||"Untitled"));return await Y(n.id,n.name),{sendResponse:!0,response:{success:!0,doc:{id:n.id,name:n.name}}}}catch(n){return A.bg.warn("DOCS_CREATE failed",n),{sendResponse:!0,response:{success:!1,error:n instanceof Error?n.message:String(n)}}}}if(r==="GET_PLUG_SELECTION"){const o=e.tabId;if(!o)return{sendResponse:!0,response:{success:!1,error:"No tab"}};try{const n=await chrome.tabs.get(o),s=await q(n);return{sendResponse:!0,response:{success:!0,selection:{selectedText:s.selectedText,pageUrl:s.pageUrl,pageTitle:s.pageTitle,timestamp:s.timestamp}}}}catch(n){return A.bg.warn("GET_PLUG_SELECTION failed",n),{sendResponse:!0,response:{success:!1,error:n instanceof Error?n.message:String(n)}}}}if(r==="DOCS_GET_SECTIONS")try{const o=await k();return o?{sendResponse:!0,response:{success:!0,sections:await R(s=>Ve(o,s))}}:{sendResponse:!0,response:{success:!1,error:"No document selected"}}}catch(o){return A.bg.warn("DOCS_GET_SECTIONS failed",o),{sendResponse:!0,response:{success:!1,error:o instanceof Error?o.message:String(o)}}}if(r==="PLUG_IT_IN_AT_SECTION"){const{selectionData:o,insertIndex:n}=e;if(!o||typeof n!="number")return{sendResponse:!0,response:{success:!1,error:"Missing selectionData or insertIndex"}};try{const s=await k();return s?(await R(i=>qe(s,i,o,n)),{sendResponse:!0,response:{success:!0}}):{sendResponse:!0,response:{success:!1,error:"No document selected"}}}catch(s){return A.bg.warn("PLUG_IT_IN_AT_SECTION failed",s),{sendResponse:!0,response:{success:!1,error:s instanceof Error?s.message:String(s)}}}}return r==="GET_DOC_PREVIEW"?((async()=>{let o;try{const n=await k();if(!n)o={error:"No document selected"};else{const s=await R(async i=>{const a=await He(n,i);return await Be(a.blocks,i),a});o={title:s.title,blocks:s.blocks}}}catch(n){o={error:n instanceof Error?n.message:"Failed to load preview"}}try{chrome.runtime.sendMessage({type:"DOC_PREVIEW_RESULT",...o})}catch{}})(),{sendResponse:!1}):null}const W="eznote_snip_overlay_active",X="eznote_snip_tab_id",M=chrome.storage?.session||chrome.storage?.local;function G(e,t=null){return M?M.set({[W]:!!e,[X]:e&&t!=null?t:null}):Promise.resolve()}function pt(){return M?M.get(W).then(e=>!!e[W]):Promise.resolve(!1)}chrome.runtime.onInstalled.addListener(()=>{Qe()}),chrome.action.onClicked.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e?.[0];t?.windowId&&chrome.sidePanel.open({windowId:t.windowId}).catch(r=>A.bg.error("open side panel failed",r))})}),chrome.tabs.onUpdated.addListener((e,t)=>{t.status==="loading"&&M?.get(X).then(r=>{r[X]===e&&G(!1)})}),chrome.contextMenus.onClicked.addListener((e,t)=>{et(e,t).catch(r=>A.bg.error("plug it in failed",r))}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(["AUTH_GET_STATUS","AUTH_CONNECT","AUTH_DISCONNECT","DOCS_LIST","DOCS_SET_SELECTED","DOCS_CREATE","DOCS_GET_SECTIONS","GET_PLUG_SELECTION","PLUG_IT_IN_AT_SECTION","GET_DOC_PREVIEW"].includes(e?.type))return mt(e).then(n=>{n&&n.sendResponse&&r(n.response)}).catch(n=>{A.bg.error("messageHub",n),r({error:n instanceof Error?n.message:String(n)})}),!0;if(e.type==="START_SNIP"){const n=e.tabId??t.tab?.id;return n?(V(),ce(n).then(()=>r({ok:!0}),s=>r({error:String(s)}))):r({error:"No tab"}),!0}if(e.type==="SNIP_START_WITH_SECTION"){const n=e.tabId??t.tab?.id,s=e.insertIndex;return!n||typeof s!="number"?(r({ok:!1,error:"Missing tab or insertIndex"}),!0):(ht(s).then(()=>ce(n)).then(()=>r({ok:!0}),i=>r({error:String(i)})),!0)}if(e.type==="SNIP_OVERLAY_CREATED"){const n=t.tab?.id;return n&&G(!0,n),!1}if(e.type==="SNIP_BOUNDS"){G(!1);const n=t.tab?.id,s=t.tab?.windowId??null;return n&&e.bounds?gt(n,e.bounds,s,{pageUrl:e.pageUrl,pageTitle:e.pageTitle}).then(()=>r({ok:!0}),i=>r({error:String(i)})):r({error:"No tab or bounds"}),!0}if(e.type==="SNIP_CANCEL")return G(!1),V(),r({ok:!0}),!0;if(e.type==="PLUG_IT_IN"){const n=e.tabId??t.tab?.id;return n?tt(n).then(()=>r({ok:!0}),s=>r({error:String(s)})):r({error:"No tab"}),!0}return e.type==="GET_SNIP_STATE"?(pt().then(n=>r({active:n})),!0):(e.type==="SNIP_OVERLAY_CLOSED"&&G(!1),!1)})})();
